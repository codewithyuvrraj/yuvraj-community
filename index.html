<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>BusinessConnect - Professional Social Platform</title>
    <link rel="icon" type="image/png" href="logo.png" style="border-radius: 50%;">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- Registration Fix -->
    <script src="registration-fix.js"></script>
    <!-- Simple Instant Chat -->
    <script src="simple-instant-chat.js"></script>
    <!-- Presence Manager -->
    <script src="presence-manager.js"></script>
    <!-- Auth Debug -->
    <script src="auth-debug.js"></script>
    <!-- Debug Chat -->
    <script src="debug-chat.js"></script>
    <!-- Test Messaging -->
    <script src="test-messaging.js"></script>
    <!-- Chat Settings -->
    <script src="chat-settings.js"></script>
    <!-- Chat Lock -->
    <script src="chat-lock.js"></script>
    <!-- Lock Manager -->
    <script src="lock-manager.js"></script>
    <!-- Group Chat Manager -->
    <script src="group-chat.js"></script>
    <!-- Group Notifications -->
    <script src="group-notifications.js?v=2"></script>
    <!-- Group Member Manager -->
    <script src="group-member-manager.js?v=2"></script>
    <!-- Group Leave Manager -->
    <script src="group-leave-manager.js"></script>
    
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            height: 100vh;
            overflow: auto;
            line-height: 1.6;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Mobile viewport fixes */
        @supports (padding: max(0px)) {
            .chat-header {
                padding-left: max(16px, env(safe-area-inset-left));
                padding-right: max(16px, env(safe-area-inset-right));
            }
        }

        /* Professional Business Theme */
        .business-gradient {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #06b6d4 100%);
        }

        .premium-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* App Container */
        .app-container {
            display: flex;
            height: 100vh;
            background: white;
            position: relative;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            max-width: 320px;
            background: #1E40AF;
            color: white;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            transition: width 0.3s ease;
            flex-shrink: 0;
        }

        .sidebar.hidden {
            width: 0;
            min-width: 0;
            max-width: 0;
        }

        .sidebar.fullscreen {
            width: 100vw;
            max-width: 100vw;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 9999;
            height: 100vh;
        }

        .sidebar-resizer {
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            cursor: ew-resize;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .sidebar:hover .sidebar-resizer {
            opacity: 1;
        }

        /* Modal Styles */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .overlay.active {
            overflow-y: auto;
        }

        .settings-modal, .search-modal {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow: hidden;
        }

        .settings-header, .search-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .search-header input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            margin-right: 10px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
        }

        .close-btn:hover {
            background: #f3f4f6;
        }

        /* Settings Styles */
        .settings-content {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .settings-section {
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .settings-section h4 {
            color: #374151;
            margin-bottom: 16px;
            font-size: 18px;
            font-weight: 600;
        }

        .setting-item {
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .setting-item label {
            font-weight: 500;
            color: #374151;
            min-width: 120px;
        }

        .setting-input {
            padding: 8px 12px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 14px;
            flex: 1;
            max-width: 200px;
        }

        .setting-input:focus {
            outline: none;
            border-color: #1E40AF;
        }

        .setting-select {
            padding: 8px 12px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .slider {
            flex: 1;
            max-width: 200px;
            margin-right: 10px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: #10B981;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .user-avatar:hover::after {
            content: '📷';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .user-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
        }

        /* Fixed UID Display CSS */
        .uid-display {
            background: rgba(255, 255, 255, 0.15);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-family: 'Courier New', monospace;
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 140px;
            margin-top: 2px;
        }

        .uid-display span {
            color: rgba(255, 255, 255, 0.8);
            font-weight: 400;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .uid-copy {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 4px;
            flex-shrink: 0;
        }

        .uid-copy:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .logout-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: background 0.2s;
            margin-left: auto;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Search Section - Updated for WhatsApp style */
        .search-section {
            padding: 16px;
            position: relative;
            z-index: 10;
            background: #1E40AF;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .search-box {
            position: relative;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px;
            padding-right: 40px;
            border: none;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
        }

        .search-box input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .search-box i {
            position: absolute;
            right: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 16px;
            right: 16px;
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 1000;
            margin-top: 8px;
        }

        .search-result-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.2s;
            color: #374151;
            border-bottom: 1px solid #f3f4f6;
        }

        .search-result-item:hover {
            background: #f3f4f6;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #1E40AF;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            flex-shrink: 0;
        }

        .search-result-info {
            flex: 1;
            overflow: hidden;
        }

        .search-result-name {
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .search-result-username {
            font-size: 12px;
            color: #6B7280;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .search-result-email {
            font-size: 12px;
            color: #6B7280;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* UID Search Section */
        .uid-search-section {
            padding: 0 16px 16px;
        }

        /* Navigation */
        .sidebar-nav {
            padding: 16px 0;
            flex: 1;
            overflow-y: auto;
        }

        .sidebar-nav ul {
            list-style: none;
        }

        .nav-item {
            padding: 16px 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.15);
            border-right: 3px solid #10B981;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #F8FAFC;
        }

        /* Chat Header - Updated for business style */
        .chat-header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            padding: 12px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            min-height: 60px;
        }

        .chat-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-info h3 {
            color: white;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .status-indicator {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
        }

        .chat-actions {
            display: flex;
            gap: 8px;
        }

        .menu-toggle {
            display: block;
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .menu-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        .back-btn {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            margin-right: 8px;
            transition: all 0.2s;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        /* Home Feed */
        .home-feed {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }

        .feed-header {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .feed-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 16px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #1e40af;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .followed-user {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #e2e8f0;
            position: relative;
            overflow: hidden;
        }

        .followed-user::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, #1e40af, #06b6d4);
        }

        .followed-user:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .business-card {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .business-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            transform: rotate(45deg);
        }

        .followed-user-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1e40af, #06b6d4);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(30, 64, 175, 0.3);
            position: relative;
            overflow: hidden;
        }

        .followed-user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }



        .unread-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            z-index: 10;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }

        .followed-user-info {
            flex: 1;
        }

        .followed-user-name {
            font-weight: 700;
            font-size: 18px;
            margin-bottom: 4px;
            color: #1f2937;
        }

        .followed-user-status {
            color: #10b981;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .followed-user-job {
            color: #1e40af;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .followed-user-company {
            color: #6b7280;
            font-size: 13px;
            font-weight: 500;
        }

        .followed-user-bio {
            color: #4b5563;
            font-size: 12px;
            margin-top: 8px;
            line-height: 1.4;
            max-height: 32px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .message-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: white;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(30, 64, 175, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .message-btn:hover {
            background: linear-gradient(135deg, #1d4ed8, #2563eb);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(30, 64, 175, 0.4);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-direction: column;
        }

        .profile-btn {
            padding: 8px 16px;
            background: transparent;
            color: #6b7280;
            border: 2px solid #e5e7eb;
            border-radius: 20px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
        }

        .profile-btn:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
            color: #374151;
        }

        .welcome-message {
            text-align: center;
            color: #667781;
            padding: 60px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .welcome-message i {
            font-size: 48px;
            margin-bottom: 16px;
            color: #cfd4d8;
        }

        .welcome-message h3 {
            font-size: 20px;
            margin-bottom: 8px;
            color: #374151;
        }

        /* WhatsApp-style Messages */
        .message {
            display: block;
            margin-bottom: 8px;
            animation: messageSlideIn 0.3s ease-out;
            clear: both;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.own {
            text-align: right;
        }

        .message:not(.own) {
            text-align: left;
        }

        .message-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #128c7e;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            margin-right: 8px;
            margin-bottom: 4px;
            vertical-align: bottom;
            font-size: 12px;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .message.own .message-avatar {
            display: none;
        }

        .message-content {
            display: inline-block;
            max-width: 65%;
            background: white;
            padding: 6px 7px 8px 9px;
            border-radius: 7.5px;
            box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
            position: relative;
            word-wrap: break-word;
            text-align: left;
        }

        .message.own .message-content {
            background: #dcf8c6;
            border-radius: 7.5px;
        }

        /* WhatsApp message tails */
        .message-content::before {
            content: '';
            position: absolute;
            top: 0;
            width: 0;
            height: 0;
        }

        .message:not(.own) .message-content::before {
            left: -7px;
            border-top: 8px solid white;
            border-left: 7px solid transparent;
            border-right: 0;
        }

        .message.own .message-content::before {
            right: -7px;
            border-top: 8px solid #dcf8c6;
            border-right: 7px solid transparent;
            border-left: 0;
        }

        .message-text {
            margin: 0;
            line-height: 1.4;
            font-size: 14.2px;
            color: #303030;
            white-space: pre-wrap;
        }

        .message-time {
            font-size: 11px;
            color: #667781;
            text-align: right;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 3px;
        }

        .message.own .message-time {
            color: #667781;
        }

        /* Message status indicators (like WhatsApp) */
        .message.own .message-time::after {
            content: '✓✓';
            color: #4fc3f7;
            font-size: 12px;
            font-weight: bold;
        }

        /* Loading animation */
        @keyframes pulse {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1); }
        }

        /* Smooth scrolling for chat container */
        .chat-messages {
            scroll-behavior: smooth;
            display: flex;
            flex-direction: column;
        }

        /* Message container spacing */
        .message + .message {
            margin-top: 2px;
        }

        /* Consecutive messages from same sender */
        .message.own + .message.own {
            margin-top: 2px;
        }

        .message:not(.own) + .message:not(.own) {
            margin-top: 2px;
        }

        .file-attachment {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #F3F4F6;
            border-radius: 8px;
            margin-top: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .file-attachment:hover {
            background: #E5E7EB;
        }

        .file-icon {
            width: 32px;
            height: 32px;
            background: #1E40AF;
            color: white;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .file-info h4 {
            font-size: 12px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 2px;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-info p {
            font-size: 10px;
            color: #6B7280;
        }

        /* Chat Input */
        .chat-input-container {
            background: #f0f2f5;
            padding: 5px 16px 5px 10px;
            border-top: 1px solid #e9edef;
        }

        .chat-input {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .attachment-btn {
            background: none;
            border: none;
            color: #54656f;
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .attachment-btn:hover {
            background: #e9edef;
        }

        .chat-input input {
            flex: 1;
            padding: 9px 12px;
            border: none;
            border-radius: 20px;
            font-size: 15px;
            transition: all 0.2s;
            min-width: 0;
            background: white;
        }

        .chat-input input:focus {
            outline: none;
        }

        #sendMessageBtn {
            padding: 8px 12px;
            border-radius: 50%;
            background: #005c4b;
        }

        #sendMessageBtn:hover {
            background: #047c64;
        }

        /* Authentication Styles */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .auth-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            width: 100%;
            max-width: 450px;
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .auth-header {
            background: linear-gradient(135deg, #1E40AF 0%, #3B82F6 100%);
            color: white;
            padding: 40px 32px;
            text-align: center;
        }

        .auth-header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .auth-header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .auth-form {
            padding: 32px;
            animation: formSlide 0.4s ease-out;
        }

        @keyframes formSlide {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .auth-form h2 {
            color: #374151;
            margin-bottom: 24px;
            font-size: 24px;
            font-weight: 600;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #F9FAFB;
        }

        .form-group input:focus {
            outline: none;
            border-color: #1E40AF;
            background: white;
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        .auth-switch {
            text-align: center;
            margin-top: 24px;
            color: #6B7280;
        }

        .auth-switch a {
            color: #1E40AF;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.2s;
            cursor: pointer;
            background: none;
            border: none;
        }

        .auth-switch a:hover {
            color: #1D4ED8;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(30, 64, 175, 0.2);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #1d4ed8 0%, #2563eb 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(30, 64, 175, 0.4);
        }

        .btn-success {
            background: #10B981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #EF4444;
            color: white;
        }

        .btn-danger:hover {
            background: #DC2626;
            transform: translateY(-2px);
        }

        .btn-icon {
            padding: 12px;
            min-width: 44px;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-icon:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .auth-form .btn {
            width: 100%;
            padding: 16px;
            font-size: 16px;
            margin-top: 8px;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            background: #10B981;
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            animation: slideInRight 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .notification.error {
            background: #EF4444;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }


        
        /* Notes and additional info styles */
        .auth-note {
            background-color: #f3f4f6;
            border-left: 4px solid #3B82F6;
            padding: 12px 16px;
            margin: 16px 0;
            border-radius: 8px;
            font-size: 14px;
            color: #4B5563;
        }
        
        .auth-note a {
            color: #1E40AF;
            text-decoration: none;
            font-weight: 500;
        }
        
        .auth-note a:hover {
            text-decoration: underline;
        }

        /* Loading States */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1E40AF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }


        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 0;
                position: absolute;
                z-index: 1000;
                height: 100vh;
            }
            
            .sidebar.active {
                width: 280px;
                max-width: 280px;
            }
            
            .sidebar.hidden {
                width: 0;
                max-width: 0;
            }

            .chat-header {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 1001;
                padding: 8px 16px;
                min-height: 56px;
                padding-top: env(safe-area-inset-top, 8px);
            }
            
            .main-content {
                padding-top: 56px;
            }
            
            .chat-messages {
                padding-top: 8px;
            }

            .chat-actions .btn {
                padding: 8px;
                min-width: 40px;
            }

            .auth-card {
                margin: 20px;
                max-width: none;
            }

            .auth-header {
                padding: 32px 24px;
            }

            .auth-form {
                padding: 24px;
            }

            .notification {
                right: 10px;
                left: 10px;
                top: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Container -->
    <div id="auth-container" class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <h1>
                    <img src="logo.png" style="width: 60px; height: 60px; border-radius: 50%; margin-right: 16px; vertical-align: middle; object-fit: cover;" alt="Logo">
                    BusinessConnect
                </h1>
                <p>Professional Social Platform</p>
            </div>

            <!-- Login Form -->
            <div id="login-form" class="auth-form">
                <h2>Welcome Back</h2>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" autocomplete="email" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" autocomplete="current-password" required>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <span id="loginBtnText">Sign In</span>
                        <div id="loginSpinner" class="loading-spinner" style="display: none;"></div>
                    </button>
                </form>
                


                <div class="auth-switch">
                    Don't have an account? <a href="#" id="showRegister">Create Account</a>
                </div>
            </div>

            <!-- Register Form -->
            <div id="register-form" class="auth-form" style="display: none;">
                <h2>Create Account</h2>
                <form id="registerForm">
                    <div class="form-group">
                        <label for="registerFullName">Full Name</label>
                        <input type="text" id="registerFullName" autocomplete="name" required>
                    </div>
                    <div class="form-group">
                        <label for="registerUsername">Username</label>
                        <input type="text" id="registerUsername" autocomplete="username" required>
                    </div>
                    <div class="form-group">
                        <label for="registerEmail">Email</label>
                        <input type="email" id="registerEmail" autocomplete="email" required>
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">Password</label>
                        <input type="password" id="registerPassword" autocomplete="new-password" required>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <span id="registerBtnText">Create Account</span>
                        <div id="registerSpinner" class="loading-spinner" style="display: none;"></div>
                    </button>
                </form>

                <div class="auth-switch">
                    Already have an account? <a href="#" id="showLogin">Sign In</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="app-container" style="display: none;">

        <!-- Main Content -->
        <div class="main-content">
            <!-- Chat Tab -->
            <div id="chat-tab" class="tab-content active">
                <div class="chat-header">
                    <button class="menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <button class="back-btn" id="backBtn" style="display: none;">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="chat-info">
                        <h3 id="chatTitle">
                            <img src="logo.png" style="width: 24px; height: 24px; border-radius: 50%; margin-right: 8px; vertical-align: middle;" alt="Logo">
                            BusinessConnect
                        </h3>
                        <span id="chatStatus" class="status-indicator"></span>

                    </div>
                    <div class="chat-actions">
                        <div id="influencerButtons" style="display: none; gap: 8px;">
                            <div style="position: relative; display: inline-block;">
                                <button id="groupsChannelsBtn" class="btn btn-icon" title="Groups & Channels" onclick="window.authManager.toggleGroupsChannelsDropdown()">
                                    <i class="fas fa-layer-group"></i>
                                </button>
                                <div id="groupsChannelsDropdown" style="display: none; position: absolute; top: 100%; right: 0; background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 1000; min-width: 160px; margin-top: 8px;">
                                    <div onclick="window.authManager.showMyGroups(); window.authManager.hideGroupsChannelsDropdown();" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 8px; color: #374151; transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
                                        <i class="fas fa-users" style="color: #10b981;"></i>
                                        <span>My Groups</span>
                                    </div>
                                    <div onclick="window.authManager.showJoinedGroups(); window.authManager.hideGroupsChannelsDropdown();" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 8px; color: #374151; transition: background 0.2s; border-top: 1px solid #f3f4f6;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
                                        <i class="fas fa-user-plus" style="color: #3b82f6;"></i>
                                        <span>Joined Groups</span>
                                    </div>
                                    <div onclick="window.authManager.showMyChannels(); window.authManager.hideGroupsChannelsDropdown();" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 8px; color: #374151; transition: background 0.2s; border-top: 1px solid #f3f4f6;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
                                        <i class="fas fa-broadcast-tower" style="color: #f59e0b;"></i>
                                        <span>My Channels</span>
                                    </div>
                                    <div onclick="window.authManager.showJoinedChannels(); window.authManager.hideGroupsChannelsDropdown();" style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 8px; color: #374151; transition: background 0.2s; border-top: 1px solid #f3f4f6;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
                                        <i class="fas fa-satellite-dish" style="color: #8b5cf6;"></i>
                                        <span>Joined Channels</span>
                                    </div>
                                </div>
                            </div>
                            <button id="groupsBtn" class="btn btn-icon" title="Groups" onclick="window.authManager.showMyGroups()">
                                <i class="fas fa-users"></i>
                            </button>
                            <button id="channelsBtn" class="btn btn-icon" title="Channels" onclick="window.authManager.showMyChannels()">
                                <i class="fas fa-broadcast-tower"></i>
                            </button>
                        </div>
                        <button id="searchBtn" class="btn btn-icon" title="Find Professionals">
                            <i class="fas fa-search"></i>
                        </button>
                        <button id="refreshBtn" class="btn btn-icon" title="Refresh" onclick="window.authManager.refreshHomeFeed()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button id="toolsBtn" class="btn btn-icon" title="Business Tools" onclick="window.authManager.toggleBusinessTools()">
                            <i class="fas fa-briefcase"></i>
                        </button>
                        <button id="notificationsBtn" class="btn btn-icon" title="Notifications" onclick="window.authManager.showNotifications()">
                            <i class="fas fa-bell"></i>
                            <span id="notificationBadge" style="position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; display: none; align-items: center; justify-content: center;">0</span>
                        </button>
                    </div>
                </div>

                <div class="home-feed" id="homeFeed">
                    <div class="welcome-message">
                        <i class="fas fa-users"></i>
                        <h3>Welcome to BusinessConnect</h3>
                        <p>Follow users to see them here and start conversations</p>
                    </div>
                </div>
                
                <!-- Business Tools Panel -->
                <div class="business-tools" id="businessTools" style="display: none; padding: 20px; background: #f8fafc;">
                    <div class="tools-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div class="tool-card" style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; cursor: pointer;" onclick="window.authManager.showAnalytics()">
                            <i class="fas fa-chart-line" style="font-size: 32px; color: #1e40af; margin-bottom: 12px;"></i>
                            <h4>Analytics</h4>
                            <p style="font-size: 14px; color: #6b7280;">View your network growth</p>
                        </div>
                        <div class="tool-card" style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; cursor: pointer;" onclick="window.authManager.showScheduler()">
                            <i class="fas fa-calendar" style="font-size: 32px; color: #10b981; margin-bottom: 12px;"></i>
                            <h4>Scheduler</h4>
                            <p style="font-size: 14px; color: #6b7280;">Schedule meetings</p>
                        </div>
                        <div class="tool-card" style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; cursor: pointer;" onclick="window.authManager.showLeads()">
                            <i class="fas fa-handshake" style="font-size: 32px; color: #f59e0b; margin-bottom: 12px;"></i>
                            <h4>Leads</h4>
                            <p style="font-size: 14px; color: #6b7280;">Manage business leads</p>
                        </div>
                    </div>
                </div>
                
                <!-- Chat Messages Container -->
                <div class="chat-messages" id="chatMessages" style="display: none; flex: 1; padding: 16px; overflow-y: auto; scroll-behavior: smooth; background: #e5ddd5; background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><defs><pattern id="chat-bg" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="%23ffffff" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23chat-bg)"/></svg>');">
                    <!-- Messages will be displayed here vertically like WhatsApp -->
                </div>
                
                <!-- Chat Input -->
                <div class="chat-input-container" id="chatInputContainer" style="display: none;">
                    <div class="chat-input">
                        <button class="attachment-btn" id="attachFileBtn">
                            <i class="fas fa-plus"></i>
                        </button>
                        <input type="text" id="messageInput" placeholder="Type a message">
                        <button id="sendMessageBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content" style="display: none;">
                <div class="chat-header">
                    <button class="menu-toggle" id="menuToggle2">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="chat-info">
                        <h3>Settings</h3>
                    </div>
                </div>

                <div class="settings-content">
                    <div class="settings-section">
                        <h4>Profile Settings</h4>
                        <div class="setting-item">
                            <label>Profile Photo</label>
                            <button class="btn btn-primary" id="changeProfileBtn">
                                <i class="fas fa-camera"></i> Change Photo
                            </button>
                        </div>
                        <div class="setting-item">
                            <label>Full Name</label>
                            <input type="text" id="settingsFullName" class="setting-input">
                        </div>
                        <div class="setting-item">
                            <label>Username</label>
                            <input type="text" id="settingsUsername" class="setting-input">
                        </div>
                    </div>

                    <div class="settings-section">
                        <h4>UI Settings</h4>
                        <div class="setting-item">
                            <label>Sidebar Width</label>
                            <input type="range" id="sidebarWidthSlider" min="250" max="600" value="320" class="slider">
                            <span id="sidebarWidthValue">320px</span>
                        </div>
                        <div class="setting-item">
                            <label>Theme</label>
                            <select id="themeSelect" class="setting-select">
                                <option value="light">Light</option>
                                <option value="dark">Dark</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h4>Account</h4>
                        <div class="setting-item">
                            <button class="btn btn-danger" id="settingsLogoutBtn">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- File Upload Input -->
    <input type="file" id="hiddenFileInput" style="display: none;" multiple>
    <input type="file" id="profilePhotoInput" style="display: none;" accept="image/*">

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://prxkbtexbgashpcmsjcp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InByeGtidGV4Ymdhc2hwY21zamNwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNjM4MjgsImV4cCI6MjA3NDkzOTgyOH0.rp2kWk6AQUAglx_-jeOqRjASdqXYOeI4FCtuxITRsws';

        // Initialize Supabase
        let supabase;
        let isSupabaseEnabled = false;

        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            isSupabaseEnabled = true;
            // Make globally accessible
            window.supabase = supabase;
            window.isSupabaseEnabled = true;
            window.SUPABASE_URL = SUPABASE_URL;
            window.SUPABASE_ANON_KEY = SUPABASE_ANON_KEY;
            console.log('Supabase initialized successfully');
        } catch (error) {
            console.log('Supabase initialization error:', error);
            isSupabaseEnabled = false;
            window.isSupabaseEnabled = false;
        }

        // Auto-start chat if link is opened
        function checkChatLink() {
            const urlParams = new URLSearchParams(window.location.search);
            const chatUserId = urlParams.get("chat");

            if (chatUserId && window.chatManager) {
                setTimeout(() => {
                    window.chatManager.startConversation(chatUserId);
                    window.authManager.showNotification("Chat started via shared link", "success");
                }, 1000);
            }
        }

        // Run when app starts
        window.addEventListener("load", checkChatLink);

        // Authentication Manager
        class AuthManager {
            constructor() {
                this.currentUser = null;
                this.users = JSON.parse(localStorage.getItem('businessconnect_users') || '[]');


                this.currentGroupsData = [];
                this.initializeAuth();
            }

            initializeAuth() {
                const savedUser = localStorage.getItem('businessconnect_current_user');
                if (savedUser) {
                    this.currentUser = JSON.parse(savedUser);
                    this.showApp();
                } else {
                    this.showAuth();
                }

                this.setupFormHandlers();
            }

            setupFormHandlers() {
                const loginForm = document.getElementById('loginForm');
                const registerForm = document.getElementById('registerForm');
                const showRegister = document.getElementById('showRegister');
                const showLogin = document.getElementById('showLogin');
                loginForm.addEventListener('submit', (e) => this.handleLogin(e));
                registerForm.addEventListener('submit', (e) => this.handleRegister(e));
                showRegister.addEventListener('click', (e) => this.showRegisterForm(e));
                showLogin.addEventListener('click', (e) => this.showLoginForm(e));
            }

            async handleLogin(e) {
                e.preventDefault();
                this.setLoading('login', true);

                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;

                try {
                    if (isSupabaseEnabled) {
                        console.log('Attempting Supabase login for:', email);
                        
                        // Try Supabase Auth
                        const { data, error } = await supabase.auth.signInWithPassword({
                            email: email,
                            password: password
                        });

                        if (error) throw error;

                        const uid = data.user.id;
                        console.log('Supabase auth successful, UID:', uid);

                        // Fetch user profile from profiles table
                        const { data: profile, error: profileError } = await supabase
                            .from('profiles')
                            .select('*')
                            .eq('id', uid)
                            .single();

                        if (profileError) {
                            console.error('No user profile found in profiles table for UID:', uid);
                            throw new Error("No user profile found. Did signup succeed?");
                        }

                        this.currentUser = profile;
                        console.log('User profile loaded:', this.currentUser);
                        

                    } else {
                        console.log('Using local authentication fallback');
                        
                        // Local fallback
                        const user = this.users.find(u => u.email === email && u.password === password);
                        if (!user) {
                            console.error('Invalid credentials in local storage');
                            throw new Error('Invalid credentials');
                        }
                        this.currentUser = user;
                    }

                    localStorage.setItem('businessconnect_current_user', JSON.stringify(this.currentUser));
                    this.setupPresenceTracking();
                    this.showNotification('Login successful!', 'success');
                    setTimeout(async () => await this.showApp(), 500);
                } catch (error) {
                    console.error("Login error:", error);
                    
                    let errorMessage = 'Login failed';
                    if (error.message.includes('Invalid login credentials')) {
                        errorMessage = 'Invalid email or password';
                    } else if (error.message.includes('Email not confirmed')) {
                        errorMessage = 'Please confirm your email address';
                    } else {
                        errorMessage = error.message || 'Login failed';
                    }
                    
                    this.showNotification(errorMessage, 'error');
                } finally {
                    this.setLoading('login', false);
                }
            }

            async handleRegister(e) {
                e.preventDefault();
                this.setLoading('register', true);

                const username = document.getElementById('registerUsername').value.trim();
                const email = document.getElementById('registerEmail').value.trim().toLowerCase();
                const password = document.getElementById('registerPassword').value;
                const fullName = document.getElementById('registerFullName').value.trim();

                // Client-side validation
                if (!username || !email || !password || !fullName) {
                    this.showNotification('All fields are required', 'error');
                    this.setLoading('register', false);
                    return;
                }

                if (password.length < 6) {
                    this.showNotification('Password must be at least 6 characters', 'error');
                    this.setLoading('register', false);
                    return;
                }

                if (!email.includes('@') || !email.includes('.')) {
                    this.showNotification('Please enter a valid email address', 'error');
                    this.setLoading('register', false);
                    return;
                }

                try {
                    if (isSupabaseEnabled && window.RegistrationManager) {
                        console.log('Using enhanced RegistrationManager for signup');
                        
                        const registrationManager = new window.RegistrationManager(supabase);
                        const result = await registrationManager.registerUser({
                            username,
                            email,
                            password,
                            fullName
                        });
                        
                        if (!result.success) {
                            throw new Error(result.error);
                        }
                        
                        this.currentUser = result.user;
                        this.showNotification(result.message || 'Account created successfully!', 'success');
                        
                        // Store user data locally as backup
                        localStorage.setItem('businessconnect_current_user', JSON.stringify(this.currentUser));
                        
                        // Add to local users array
                        const localUsers = JSON.parse(localStorage.getItem('businessconnect_users') || '[]');
                        const existingIndex = localUsers.findIndex(u => u.id === this.currentUser.id);
                        if (existingIndex >= 0) {
                            localUsers[existingIndex] = this.currentUser;
                        } else {
                            localUsers.push(this.currentUser);
                        }
                        localStorage.setItem('businessconnect_users', JSON.stringify(localUsers));
                        
                    } else {
                        console.log('Using local registration fallback');
                        
                        // Local fallback
                        if (this.users.find(u => u.email === email)) {
                            throw new Error('Email already exists');
                        }

                        const newUser = {
                            id: Date.now().toString(),
                            username,
                            email,
                            password, // only stored locally
                            full_name: fullName,

                            joined_at: new Date().toISOString()
                        };

                        this.users.push(newUser);
                        localStorage.setItem('businessconnect_users', JSON.stringify(this.users));
                        this.currentUser = newUser;
                        localStorage.setItem('businessconnect_current_user', JSON.stringify(this.currentUser));
                        this.showNotification('Account created successfully!', 'success');
                    }

                    // Show success and transition to app
                    setTimeout(async () => {
                        await this.showApp();
                    }, 1000);
                    
                } catch (error) {
                    console.error("Registration error:", error);
                    
                    let errorMessage = 'Registration failed';
                    if (error.message) {
                        errorMessage = error.message;
                    }
                    
                    this.showNotification(errorMessage, 'error');
                } finally {
                    this.setLoading('register', false);
                }
            }

            async copyUidToClipboard() {
                if (!this.currentUser || !this.currentUser.id) return;
                
                try {
                    await navigator.clipboard.writeText(this.currentUser.id);
                    this.showNotification('UID copied to clipboard!', 'success');
                } catch (error) {
                    console.error('Failed to copy UID:', error);
                    this.showNotification('Failed to copy UID', 'error');
                }
            }

            setLoading(type, loading) {
                const btnText = document.getElementById(`${type}BtnText`);
                const spinner = document.getElementById(`${type}Spinner`);
                
                if (loading) {
                    btnText.style.display = 'none';
                    spinner.style.display = 'block';
                } else {
                    btnText.style.display = 'block';
                    spinner.style.display = 'none';
                }
            }

            showRegisterForm(e) {
                e.preventDefault();
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('register-form').style.display = 'block';
            }

            showLoginForm(e) {
                e.preventDefault();
                document.getElementById('register-form').style.display = 'none';
                document.getElementById('login-form').style.display = 'block';
            }

            async logout() {
                try {
                    if (isSupabaseEnabled && this.currentUser) {

                        await supabase.auth.signOut();
                    }
                } catch (error) {
                    console.error('Logout error:', error);
                }
                
                // Close any open modals/overlays
                document.querySelectorAll('.overlay').forEach(modal => modal.remove());
                
                localStorage.removeItem('businessconnect_current_user');
                this.currentUser = null;
                this.showAuth();
                this.showNotification('Logged out successfully', 'success');
            }

            showAuth() {
                document.getElementById('auth-container').style.display = 'flex';
                document.getElementById('app-container').style.display = 'none';
            }

            async showApp() {
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                // User info is now handled in modals
                
                // Initialize app components
                if (window.chatManager) {
                    await window.chatManager.initialize();
                } else {
                    // Fallback initialization
                    setTimeout(async () => {
                        if (window.chatManager) await window.chatManager.initialize();
                    }, 100);
                }
                

                
                // Setup menu toggle for settings
                document.getElementById('menuToggle').addEventListener('click', () => {
                    this.showSettings();
                });
                
                // Setup back button to go back to home feed
                document.getElementById('backBtn').addEventListener('click', () => {
                    this.goBackToHomeFeed();
                });
                
                // Handle browser back button
                window.addEventListener('popstate', (e) => {
                    if (window.chatManager && window.chatManager.currentConversation) {
                        e.preventDefault();
                        this.goBackToHomeFeed();
                    }
                });
                
                // Setup search button
                document.getElementById('searchBtn').addEventListener('click', () => {
                    this.showSearchModal();
                });
                
                // Close dropdowns when clicking elsewhere
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('#groupsChannelsBtn') && !e.target.closest('#groupsChannelsDropdown')) {
                        this.hideGroupsChannelsDropdown();
                    }
                });
                
                // Setup global user access
                this.makeUsersGloballyAccessible();
                
                // Load home feed
                this.loadHomeFeed();
                
                // Update notification badge
                this.updateNotificationBadge();
                
                // Check for notifications periodically
                setInterval(() => {
                    this.updateNotificationBadge();
                }, 30000);
                
                // Listen for storage changes to refresh feed when follows change
                window.addEventListener('storage', (e) => {
                    if (e.key === 'feed_refresh') {
                        this.loadHomeFeed();
                    }
                });
                
                // Listen for custom events
                window.addEventListener('followChanged', () => {
                    this.loadHomeFeed();
                });
                
                // Listen for messages from search window
                window.addEventListener('message', (e) => {
                    if (e.data === 'followChanged') {
                        this.loadHomeFeed();
                    }
                });
                
                // Listen for page visibility to refresh feed
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden) {
                        this.loadHomeFeed();
                    }
                });
                
                // Setup profile photo upload
                const profilePhotoInput = document.getElementById('profilePhotoInput');
                if (profilePhotoInput) {
                    profilePhotoInput.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            this.uploadProfilePhoto(file);
                            // Clear the input so same file can be selected again
                            e.target.value = '';
                        }
                    });
                }
                

                
                // Setup settings
                this.setupSettings();
                
                // Check influencer mode status
                this.loadInfluencerStatus();
                
                // Check for chat link after login
                checkChatLink();
                
                // Check if we need to start a chat from search page
                const startChatWith = localStorage.getItem('start_chat_with');
                if (startChatWith) {
                    localStorage.removeItem('start_chat_with');
                    setTimeout(() => {
                        window.chatManager.startConversation(startChatWith);
                    }, 1000);
                }
            }

            async copyChatLink(otherUserId) {
                const currentUser = this.getCurrentUser();
                if (!currentUser) {
                    this.showNotification("Please login first", "error");
                    return;
                }

                // Generate chat link
                let baseUrl = window.location.origin + window.location.pathname;
                if (baseUrl.endsWith("index.html")) {
                    baseUrl = baseUrl.replace("index.html", "");
                }
                const link = `${baseUrl}?chat=${otherUserId}`;

                // Copy to clipboard
                try {
                    await navigator.clipboard.writeText(link);
                    this.showNotification("Chat link copied: " + link, "success");
                } catch (err) {
                    console.error(err);
                    this.showNotification("Failed to copy chat link", "error");
                }
            }



            showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : 'exclamation-triangle'}"></i> ${message}`;
                document.body.appendChild(notification);

                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 3000);
            }

            async uploadProfilePhoto(file) {
                try {
                    // Validate file type
                    if (!file.type.startsWith('image/')) {
                        throw new Error('Please select an image file');
                    }
                    
                    // Validate file size (max 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        throw new Error('Image size must be less than 5MB');
                    }
                    
                    this.showNotification('Uploading profile photo...', 'success');
                    
                    let photoUrl;
                    
                    if (isSupabaseEnabled) {
                        // Delete old photo if exists
                        if (this.currentUser.profile_photo && this.currentUser.profile_photo.includes('supabase')) {
                            const oldFileName = this.currentUser.profile_photo.split('/').pop();
                            await supabase.storage.from('documents').remove([oldFileName]);
                        }
                        
                        const fileName = `profile_${this.currentUser.id}_${Date.now()}.${file.name.split('.').pop()}`;
                        const { data, error } = await supabase.storage
                            .from('documents')
                            .upload(fileName, file, {
                                cacheControl: '3600',
                                upsert: false
                            });
                        
                        if (error) {
                            console.error('Storage upload error:', error);
                            throw new Error('Failed to upload to storage: ' + error.message);
                        }
                        
                        const { data: urlData } = supabase.storage
                            .from('documents')
                            .getPublicUrl(fileName);
                        
                        photoUrl = urlData.publicUrl;
                        
                        // Update profile in database
                        const { error: updateError } = await supabase
                            .from('profiles')
                            .update({ profile_photo: photoUrl })
                            .eq('id', this.currentUser.id);
                        
                        if (updateError) {
                            console.error('Database update error:', updateError);
                            throw new Error('Failed to update profile: ' + updateError.message);
                        }
                    } else {
                        photoUrl = URL.createObjectURL(file);
                    }
                    
                    this.currentUser.profile_photo = photoUrl;
                    localStorage.setItem('businessconnect_current_user', JSON.stringify(this.currentUser));
                    
                    // Update all profile photos in the UI immediately
                    const avatars = document.querySelectorAll('.user-avatar img, .followed-user-avatar img');
                    avatars.forEach(img => {
                        if (img.closest('.user-info') || img.closest('.followed-user-avatar')) {
                            img.src = photoUrl;
                        }
                    });
                    
                    // Update profile preview in settings modal if open
                    const profilePreview = document.getElementById('profilePreview');
                    if (profilePreview) {
                        profilePreview.innerHTML = `<img src="${photoUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
                    }
                    
                    // Reload home feed to show updated photo
                    this.loadHomeFeed();
                    
                    this.showNotification('Profile photo updated successfully!', 'success');
                } catch (error) {
                    console.error('Error uploading profile photo:', error);
                    this.showNotification(error.message || 'Failed to upload profile photo', 'error');
                }
            }



            showSettings() {
                const settingsHtml = `
                    <div class="overlay" id="settingsOverlay">
                        <div class="settings-modal" style="max-width: 500px; max-height: 90vh;">
                            <div class="settings-header" style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white;">
                                <h3><i class="fas fa-cog"></i> Business Settings</h3>
                                <button class="close-btn" onclick="document.getElementById('settingsOverlay').remove()" style="color: white;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="settings-content" style="max-height: 70vh; overflow-y: auto;">
                                
                                <!-- Profile Section -->
                                <div class="settings-section" style="background: #f8fafc; border-left: 4px solid #3b82f6;">
                                    <h4><i class="fas fa-user-tie"></i> Professional Profile</h4>
                                    <div class="setting-item" style="flex-direction: column; align-items: flex-start;">
                                        <label>Profile Photo</label>
                                        <div style="display: flex; align-items: center; gap: 16px; width: 100%;">
                                            <div id="profilePreview" style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #1e40af, #06b6d4); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 20px; overflow: hidden;">
                                                ${this.currentUser.profile_photo ? 
                                                    `<img src="${this.currentUser.profile_photo}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` :
                                                    (this.currentUser.full_name || this.currentUser.username).charAt(0).toUpperCase()
                                                }
                                            </div>
                                            <button class="btn btn-primary" onclick="document.getElementById('profilePhotoInput').click()">
                                                <i class="fas fa-camera"></i> Change Photo
                                            </button>
                                        </div>
                                    </div>
                                    <div class="setting-item" style="flex-direction: column; align-items: flex-start;">
                                        <label>Bio</label>
                                        <textarea id="profileBio" class="setting-input" style="width: 100%; max-width: none; min-height: 60px; resize: vertical;" placeholder="Tell others about yourself..."></textarea>
                                    </div>
                                    <div class="setting-item">
                                        <label>Job Title</label>
                                        <input type="text" id="jobTitle" class="setting-input" placeholder="CEO, Manager, etc.">
                                    </div>
                                    <div class="setting-item">
                                        <label>Company</label>
                                        <input type="text" id="company" class="setting-input" placeholder="Company Name">
                                    </div>
                                    <div class="setting-item">
                                        <label>Industry</label>
                                        <select id="industry" class="setting-select">
                                            <option>Technology</option>
                                            <option>Finance</option>
                                            <option>Healthcare</option>
                                            <option>Manufacturing</option>
                                            <option>Retail</option>
                                            <option>Education</option>
                                            <option>Other</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Business Settings -->
                                <div class="settings-section" style="background: #f0fdf4; border-left: 4px solid #10b981;">
                                    <h4><i class="fas fa-briefcase"></i> Business Preferences</h4>
                                    <div class="setting-item">
                                        <label>Business Hours</label>
                                        <select id="businessHours" class="setting-select">
                                            <option>9 AM - 5 PM</option>
                                            <option>8 AM - 6 PM</option>
                                            <option>24/7 Available</option>
                                            <option>Custom</option>
                                        </select>
                                    </div>
                                    <div class="setting-item">
                                        <label>Time Zone</label>
                                        <select id="timezone" class="setting-select">
                                            <option>UTC-8 (PST)</option>
                                            <option>UTC-5 (EST)</option>
                                            <option>UTC+0 (GMT)</option>
                                            <option>UTC+5:30 (IST)</option>
                                        </select>
                                    </div>
                                    <div class="setting-item">
                                        <label>Auto-Reply</label>
                                        <select id="autoReply" class="setting-select">
                                            <option>Enabled</option>
                                            <option>Business Hours Only</option>
                                            <option>Disabled</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Privacy & Security -->
                                <div class="settings-section" style="background: #fef3c7; border-left: 4px solid #f59e0b;">
                                    <h4><i class="fas fa-shield-alt"></i> Privacy & Security</h4>
                                    <div class="setting-item">
                                        <label>Profile Visibility</label>
                                        <select class="setting-select">
                                            <option>Public</option>
                                            <option>Connections Only</option>
                                            <option>Private</option>
                                        </select>
                                    </div>
                                    <div class="setting-item">
                                        <label>Message Requests</label>
                                        <select class="setting-select">
                                            <option>Everyone</option>
                                            <option>Connections Only</option>
                                            <option>No One</option>
                                        </select>
                                    </div>
                                    <div class="setting-item">
                                        <label>Read Receipts</label>
                                        <select class="setting-select">
                                            <option>Enabled</option>
                                            <option>Disabled</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Notifications -->
                                <div class="settings-section" style="background: #ede9fe; border-left: 4px solid #8b5cf6;">
                                    <h4><i class="fas fa-bell"></i> Notifications</h4>
                                    <div class="setting-item">
                                        <label>Email Notifications</label>
                                        <select class="setting-select">
                                            <option>All Messages</option>
                                            <option>Important Only</option>
                                            <option>Disabled</option>
                                        </select>
                                    </div>
                                    <div class="setting-item">
                                        <label>Push Notifications</label>
                                        <select class="setting-select">
                                            <option>Enabled</option>
                                            <option>Business Hours Only</option>
                                            <option>Disabled</option>
                                        </select>
                                    </div>
                                    <div class="setting-item">
                                        <label>Sound Alerts</label>
                                        <select class="setting-select">
                                            <option>Professional</option>
                                            <option>Subtle</option>
                                            <option>Disabled</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Account Actions -->
                                <div class="settings-section" style="background: #fef2f2; border-left: 4px solid #ef4444;">
                                    <div style="display: flex; align-items: baseline; justify-content: space-between; margin-bottom: 16px;">
                                        <h4><i class="fas fa-user-cog"></i> Account</h4>
                                        <div style="display: flex; gap: 8px; align-items: center;">
                                            <svg onclick="window.lockManager.showUnlockOptions()" style="width: 20px; height: 20px; cursor: pointer; fill: #10b981; transition: fill 0.2s;" onmouseover="this.style.fill='#059669'" onmouseout="this.style.fill='#10b981'" viewBox="0 0 24 24" title="Unlock Features">
                                                <path d="M18,8A2,2 0 0,1 20,10V20A2,2 0 0,1 18,22H6A2,2 0 0,1 4,20V10A2,2 0 0,1 6,8H7V6A5,5 0 0,1 12,1A5,5 0 0,1 17,6H15A3,3 0 0,0 12,3A3,3 0 0,0 9,6V8H18M12,17A2,2 0 0,0 14,15A2,2 0 0,0 12,13A2,2 0 0,0 10,15A2,2 0 0,0 12,17Z"/>
                                            </svg>
                                            <svg onclick="window.lockManager.showLockOptions()" style="width: 20px; height: 20px; cursor: pointer; fill: #f59e0b; transition: fill 0.2s;" onmouseover="this.style.fill='#d97706'" onmouseout="this.style.fill='#f59e0b'" viewBox="0 0 24 24" title="Lock Features">
                                                <path d="M12,17A2,2 0 0,0 14,15C14,13.89 13.1,13 12,13A2,2 0 0,0 10,15A2,2 0 0,0 12,17M18,8A2,2 0 0,1 20,10V20A2,2 0 0,1 18,22H6A2,2 0 0,1 4,20V10C4,8.89 4.9,8 6,8H7V6A5,5 0 0,1 12,1A5,5 0 0,1 17,6V8H18M12,3A3,3 0 0,0 9,6V8H15V6A3,3 0 0,0 12,3Z"/>
                                            </svg>
                                            <svg onclick="window.authManager.showUICustomization()" style="width: 20px; height: 20px; cursor: pointer; fill: #6b7280; transition: fill 0.2s;" onmouseover="this.style.fill='#374151'" onmouseout="this.style.fill='#6b7280'" viewBox="0 0 24 24" title="UI Settings">
                                                <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="setting-item" id="deleteChatSection" style="display: none;">
                                        <button class="btn" style="background: #ef4444; color: white;" onclick="window.authManager.deleteCurrentChat()">
                                            <i class="fas fa-trash"></i> Delete Current Chat
                                        </button>
                                    </div>
                                    <div class="setting-item">
                                        <button class="btn" style="background: #3b82f6; color: white;" onclick="window.authManager.showAccountStatus()">
                                            <i class="fas fa-chart-line"></i> Account Status
                                        </button>
                                        <div style="position: relative; display: inline-block;">
                                            <button id="influencerModeBtn" class="btn" style="background: #8b5cf6; color: white; position: relative; overflow: hidden;" onclick="window.authManager.toggleInfluencerMode()" onmouseover="this.querySelector('.hover-text').style.display='block'" onmouseout="this.querySelector('.hover-text').style.display='none'">
                                                <i class="fas fa-crown"></i> <span id="influencerModeText">Influencer Business</span><span id="influencerArrow" style="margin-left: 8px;"><i class="fas fa-chevron-down"></i></span>
                                                <div class="hover-text" style="display: none; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #1f2937; color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; white-space: nowrap; margin-bottom: 4px; z-index: 1000;">Influencer Business Options</div>
                                            </button>
                                            <div id="influencerDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 1000; margin-top: 4px; border: 1px solid #e5e7eb;">
                                                <div id="enableInfluencerOption" style="display: none;">
                                                    <button class="btn" style="background: #10b981; color: white; width: calc(100% - 8px); border-radius: 6px; margin: 4px; font-size: 12px;" onclick="window.authManager.enableInfluencerMode(); window.authManager.hideInfluencerDropdown();">
                                                        <i class="fas fa-crown"></i> Enable Mode
                                                    </button>
                                                </div>
                                                <div id="disableInfluencerOption" style="display: none;">
                                                    <button class="btn" style="background: #ef4444; color: white; width: calc(100% - 8px); border-radius: 6px; margin: 4px; font-size: 12px;" onclick="window.authManager.disableInfluencerMode(); window.authManager.hideInfluencerDropdown();">
                                                        <i class="fas fa-times"></i> Disable Mode
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="setting-item">
                                        <button class="btn" style="background: #10b981; color: white;" onclick="window.authManager.saveSettings()">
                                            <i class="fas fa-save"></i> Save Changes
                                        </button>
                                        <button class="btn btn-danger" onclick="window.authManager.logout()">
                                            <i class="fas fa-sign-out-alt"></i> Logout
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', settingsHtml);
                
                // Load current settings
                setTimeout(() => {
                    document.getElementById('profileBio').value = this.currentUser.bio || '';
                    document.getElementById('jobTitle').value = this.currentUser.job_title || '';
                    document.getElementById('company').value = this.currentUser.company || '';
                    document.getElementById('industry').value = this.currentUser.industry || 'Technology';
                    document.getElementById('businessHours').value = this.currentUser.business_hours || '9 AM - 5 PM';
                    document.getElementById('timezone').value = this.currentUser.timezone || 'UTC+0 (GMT)';
                    document.getElementById('autoReply').value = this.currentUser.auto_reply || 'Disabled';
                    
                    // Show delete chat button if in a conversation
                    this.showDeleteChatInSettings();
                }, 100);
            }
            
            async refreshHomeFeed() {
                const refreshBtn = document.getElementById('refreshBtn');
                if (refreshBtn) {
                    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                }
                await this.loadHomeFeed();
                await this.updateNotificationBadge();
                if (refreshBtn) {
                    refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
                }
            }
            
            async loadHomeFeed() {
                const homeFeed = document.getElementById('homeFeed');
                
                if (!isSupabaseEnabled) {
                    homeFeed.innerHTML = `
                        <div class="feed-header">
                            <h2><i class="fas fa-briefcase"></i> Welcome, ${this.currentUser.full_name || this.currentUser.username}</h2>
                            <p>Your professional dashboard</p>
                            <div class="feed-stats">
                                <div class="stat-item">
                                    <div class="stat-number">0</div>
                                    <div class="stat-label">Connections</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-number">0</div>
                                    <div class="stat-label">Messages</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-number">∞</div>
                                    <div class="stat-label">Opportunities</div>
                                </div>
                            </div>
                        </div>
                        <div class="business-card">
                            <h3><i class="fas fa-rocket"></i> Start Building Your Network</h3>
                            <p>Connect with professionals in your industry and expand your business reach</p>
                            <button class="btn" style="background: rgba(255,255,255,0.2); color: white; margin-top: 12px;" onclick="window.authManager.showSearchModal()">
                                <i class="fas fa-search"></i> Find Professionals
                            </button>
                        </div>
                    `;
                    return;
                }
                
                try {
                    // Single optimized query with join
                    const { data: followsData } = await supabase
                        .from('follows')
                        .select('following_id, profiles!follows_following_id_fkey(id, full_name, username, profile_photo, job_title, company, bio)')
                        .eq('follower_id', this.currentUser.id)
                        .limit(20);
                    
                    if (!followsData || followsData.length === 0) {
                        homeFeed.innerHTML = `
                            <div class="feed-header">
                                <h2><i class="fas fa-briefcase"></i> Welcome, ${this.currentUser.full_name || this.currentUser.username}</h2>
                                <p>Your professional dashboard</p>
                            </div>
                            <div class="business-card">
                                <h3><i class="fas fa-rocket"></i> Start Building Your Network</h3>
                                <p>Connect with professionals in your industry and expand your business reach</p>
                                <button class="btn" style="background: rgba(255,255,255,0.2); color: white; margin-top: 12px;" onclick="window.authManager.showSearchModal()">
                                    <i class="fas fa-search"></i> Find Professionals
                                </button>
                            </div>
                        `;
                        return;
                    }
                    
                    const users = followsData.map(f => f.profiles).filter(Boolean);
                    homeFeed.innerHTML = `
                        <div class="feed-header">
                            <h2><i class="fas fa-briefcase"></i> Welcome, ${this.currentUser.full_name || this.currentUser.username}</h2>
                            <p>${users.length} connections in your network</p>
                        </div>
                        ${users.map(user => `
                            <div class="followed-user">
                                <div class="followed-user-avatar">
                                    ${user.profile_photo ? 
                                        `<img src="${user.profile_photo}">` :
                                        (user.full_name || user.username).charAt(0).toUpperCase()
                                    }
                                </div>
                                <div class="followed-user-info">
                                    <div class="followed-user-name">${user.full_name || user.username}</div>
                                    ${user.job_title ? `<div class="followed-user-job"><i class="fas fa-briefcase"></i> ${user.job_title}</div>` : ''}
                                    ${user.company ? `<div class="followed-user-company">at ${user.company}</div>` : ''}
                                    ${user.bio ? `<div class="followed-user-bio">${user.bio}</div>` : ''}
                                </div>
                                <div class="action-buttons">
                                    <button class="message-btn" onclick="window.authManager.checkMessageLockAndStart('${user.id}')">
                                        <i class="fas fa-comment"></i> Message
                                    </button>
                                    <button class="profile-btn" onclick="window.authManager.showUserProfile('${user.id}')">
                                        <i class="fas fa-user"></i> Profile
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    `;
                    
                } catch (error) {
                    console.error('Error loading home feed:', error);
                    homeFeed.innerHTML = `
                        <div class="welcome-message">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>Connection Error</h3>
                            <p>Unable to load your professional network. Please check your connection.</p>
                            <button class="btn btn-primary" onclick="window.authManager.loadHomeFeed()" style="margin-top: 16px;">
                                <i class="fas fa-refresh"></i> Retry
                            </button>
                        </div>
                    `;
                }
            }

            async saveSettings() {
                try {
                    const settings = {
                        bio: document.getElementById('profileBio').value,
                        job_title: document.getElementById('jobTitle').value,
                        company: document.getElementById('company').value,
                        industry: document.getElementById('industry').value,
                        business_hours: document.getElementById('businessHours').value,
                        timezone: document.getElementById('timezone').value,
                        auto_reply: document.getElementById('autoReply').value
                    };
                    
                    if (isSupabaseEnabled) {
                        const { error } = await supabase
                            .from('profiles')
                            .update(settings)
                            .eq('id', this.currentUser.id);
                        
                        if (error) throw error;
                    }
                    
                    // Update local user object
                    Object.assign(this.currentUser, settings);
                    localStorage.setItem('businessconnect_current_user', JSON.stringify(this.currentUser));
                    
                    this.showNotification('Professional profile updated successfully!', 'success');
                    document.getElementById('settingsOverlay').remove();
                    
                    // Refresh home feed to show updated info
                    this.loadHomeFeed();
                } catch (error) {
                    console.error('Error saving settings:', error);
                    this.showNotification('Failed to save settings', 'error');
                }
            }
            
            async showUserProfile(userId) {
                try {
                    let user;
                    let isFollowing = false;
                    if (isSupabaseEnabled) {
                        // First get user profile
                        const { data: profileData, error: profileError } = await supabase
                            .from('profiles')
                            .select('*')
                            .eq('id', userId)
                            .single();
                        
                        if (profileError) throw profileError;
                        user = profileData;
                        
                        // Check if following - handle the case where no follow relationship exists
                        const { data: followData, error: followError } = await supabase
                            .from('follows')
                            .select('id')
                            .eq('follower_id', this.currentUser.id)
                            .eq('following_id', userId)
                            .maybeSingle();
                        
                        // Only throw error if it's not a "no rows" error
                        if (followError && followError.code !== 'PGRST116') {
                            console.error('Follow check error:', followError);
                        }
                        
                        isFollowing = followData !== null;
                        
                        // Track profile view (only if viewing someone else's profile)
                        if (userId !== this.currentUser.id) {
                            try {
                                await supabase
                                    .from('profile_views')
                                    .insert({
                                        viewer_id: this.currentUser.id,
                                        viewed_profile_id: userId
                                    });
                            } catch (viewError) {
                                // Ignore profile view errors
                                console.log('Profile view tracking failed:', viewError);
                            }
                        }
                    } else {
                        user = this.getUserById(userId);
                    }
                    
                    if (!user) {
                        this.showNotification('User not found', 'error');
                        return;
                    }
                    
                    const modal = document.createElement('div');
                    modal.className = 'overlay';
                    modal.innerHTML = `
                        <div class="settings-modal" style="max-width: 500px; max-height: 90vh;">
                            <div class="settings-header business-gradient" style="color: white;">
                                <h3><i class="fas fa-user-tie"></i> Professional Profile</h3>
                                <button class="close-btn" onclick="this.closest('.overlay').remove()" style="color: white;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="settings-content" style="max-height: 70vh; overflow-y: auto; padding: 24px;">
                                <div style="text-align: center; margin-bottom: 24px;">
                                    <div style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, #1e40af, #06b6d4); display: flex; align-items: center; justify-content: center; color: white; font-size: 36px; font-weight: 600; margin: 0 auto 16px; box-shadow: 0 8px 25px rgba(30, 64, 175, 0.3);">
                                        ${user.profile_photo ? 
                                            `<img src="${user.profile_photo}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` :
                                            (user.full_name || user.username).charAt(0).toUpperCase()
                                        }
                                    </div>
                                    <h2 style="margin: 0; color: #1f2937; font-size: 24px;">${user.full_name || user.username}</h2>
                                    <p style="margin: 4px 0; color: #6b7280;">@${user.username}</p>
                                    ${user.job_title ? `<p style="margin: 8px 0; color: #1e40af; font-weight: 600; font-size: 16px;"><i class="fas fa-briefcase"></i> ${user.job_title}</p>` : ''}
                                    ${user.company ? `<p style="margin: 4px 0; color: #6b7280;">at ${user.company}</p>` : ''}
                                </div>
                                
                                ${user.bio ? `
                                    <div style="background: #f8fafc; border-radius: 12px; padding: 16px; margin-bottom: 16px; border-left: 4px solid #3b82f6;">
                                        <h4 style="margin: 0 0 8px 0; color: #374151; display: flex; align-items: center; gap: 8px;"><i class="fas fa-quote-left"></i> About</h4>
                                        <p style="margin: 0; color: #4b5563; line-height: 1.6;">${user.bio}</p>
                                    </div>
                                ` : ''}
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                    ${user.industry ? `
                                        <div style="background: #f0fdf4; border-radius: 8px; padding: 12px; text-align: center;">
                                            <div style="color: #10b981; font-size: 20px; margin-bottom: 4px;"><i class="fas fa-industry"></i></div>
                                            <div style="font-size: 12px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Industry</div>
                                            <div style="font-weight: 600; color: #374151;">${user.industry}</div>
                                        </div>
                                    ` : ''}
                                    ${user.business_hours ? `
                                        <div style="background: #fef3c7; border-radius: 8px; padding: 12px; text-align: center;">
                                            <div style="color: #f59e0b; font-size: 20px; margin-bottom: 4px;"><i class="fas fa-clock"></i></div>
                                            <div style="font-size: 12px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Hours</div>
                                            <div style="font-weight: 600; color: #374151;">${user.business_hours}</div>
                                        </div>
                                    ` : ''}
                                </div>
                                
                                <div style="display: flex; gap: 12px; justify-content: center; margin-top: 24px;">
                                    <button class="btn btn-primary" onclick="window.authManager.checkMessageLockAndStart('${user.id}'); this.closest('.overlay').remove();">
                                        <i class="fas fa-comment"></i> Start Conversation
                                    </button>
                                    <button class="btn" id="profileFollowBtn_${user.id}" style="background: ${isFollowing ? '#ef4444' : '#10b981'}; color: white;" onclick="window.authManager.toggleFollowFromProfile('${user.id}')">
                                        <i class="fas fa-${isFollowing ? 'user-minus' : 'user-plus'}"></i> ${isFollowing ? 'Unfollow' : 'Follow'}
                                    </button>
                                    <button class="btn" style="background: #e5e7eb; color: #374151;" onclick="window.authManager.copyChatLink('${user.id}')">
                                        <i class="fas fa-share"></i> Share Profile
                                    </button>
                                </div>
                                <div style="display: flex; gap: 12px; justify-content: center; margin-top: 12px;">
                                    <button class="btn" style="background: #ef4444; color: white;" onclick="window.authManager.confirmDeleteChatFromProfile('${user.id}', '${user.full_name || user.username}'); this.closest('.overlay').remove();">
                                        <i class="fas fa-trash"></i> Delete Chat
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) modal.remove();
                    });
                } catch (error) {
                    console.error('Error loading user profile:', error);
                    this.showNotification('Failed to load user profile: ' + (error.message || 'Unknown error'), 'error');
                }
            }

            setupSettings() {
                // Settings functionality is now handled by modal
            }

            async makeUsersGloballyAccessible() {
                if (!isSupabaseEnabled) return;
                
                try {
                    // Test connection and cache users
                    const { data: allUsers, error } = await supabase
                        .from('profiles')
                        .select('*')
                        .limit(1000);
                    
                    if (!error && allUsers) {
                        localStorage.setItem('businessconnect_all_users', JSON.stringify(allUsers));
                        console.log(`✅ Connected! Cached ${allUsers.length} users for global access`);
                        

                    } else {
                        throw error || new Error('No data returned');
                    }
                } catch (error) {
                    console.error('❌ Connection failed:', error);
                    isSupabaseEnabled = false;
                    

                }
            }
            
            async getAllUsersGlobally() {
                if (isSupabaseEnabled) {
                    try {
                        const { data, error } = await supabase
                            .from('profiles')
                            .select('*')
                            .limit(1000);
                        
                        if (!error) return data || [];
                    } catch (error) {
                        console.error('Error fetching global users:', error);
                    }
                }
                
                // Fallback to cached users
                const cached = localStorage.getItem('businessconnect_all_users');
                return cached ? JSON.parse(cached) : this.users;
            }

            toggleBusinessTools() {
                const homeFeed = document.getElementById('homeFeed');
                const businessTools = document.getElementById('businessTools');
                const toolsBtn = document.getElementById('toolsBtn');
                
                if (businessTools.style.display === 'none') {
                    homeFeed.style.display = 'none';
                    businessTools.style.display = 'block';
                    toolsBtn.style.background = 'rgba(255,255,255,0.2)';
                } else {
                    homeFeed.style.display = 'block';
                    businessTools.style.display = 'none';
                    toolsBtn.style.background = 'rgba(255,255,255,0.1)';
                }
            }
            
            showAnalytics() {
                const modal = document.createElement('div');
                modal.className = 'overlay';
                modal.innerHTML = `
                    <div class="settings-modal" style="max-width: 600px;">
                        <div class="settings-header business-gradient" style="color: white;">
                            <h3><i class="fas fa-chart-line"></i> Business Analytics</h3>
                            <button class="close-btn" onclick="this.closest('.overlay').remove()" style="color: white;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="settings-content">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px;">
                                <div style="background: #f0fdf4; padding: 20px; border-radius: 12px; text-align: center;">
                                    <div style="font-size: 32px; font-weight: 700; color: #10b981;">0</div>
                                    <div style="color: #6b7280; font-size: 14px;">Connections</div>
                                </div>
                                <div style="background: #fef3c7; padding: 20px; border-radius: 12px; text-align: center;">
                                    <div style="font-size: 32px; font-weight: 700; color: #f59e0b;">0</div>
                                    <div style="color: #6b7280; font-size: 14px;">Messages Sent</div>
                                </div>
                                <div style="background: #ede9fe; padding: 20px; border-radius: 12px; text-align: center;">
                                    <div style="font-size: 32px; font-weight: 700; color: #8b5cf6;">0</div>
                                    <div style="color: #6b7280; font-size: 14px;">Profile Views</div>
                                </div>
                            </div>
                            <div style="background: #f8fafc; padding: 20px; border-radius: 12px;">
                                <h4 style="margin-bottom: 12px;">Growth Insights</h4>
                                <p style="color: #6b7280; margin-bottom: 16px;">Your professional network is just getting started. Connect with more professionals to unlock detailed analytics.</p>
                                <button class="btn btn-primary" onclick="window.authManager.showSearchModal(); this.closest('.overlay').remove();">
                                    <i class="fas fa-search"></i> Find Professionals
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            showScheduler() {
                const modal = document.createElement('div');
                modal.className = 'overlay';
                modal.innerHTML = `
                    <div class="settings-modal" style="max-width: 500px;">
                        <div class="settings-header" style="background: #10b981; color: white;">
                            <h3><i class="fas fa-calendar"></i> Meeting Scheduler</h3>
                            <button class="close-btn" onclick="this.closest('.overlay').remove()" style="color: white;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="settings-content">
                            <div style="text-align: center; padding: 40px 20px;">
                                <i class="fas fa-calendar-plus" style="font-size: 64px; color: #10b981; margin-bottom: 20px;"></i>
                                <h3>Schedule Professional Meetings</h3>
                                <p style="color: #6b7280; margin: 16px 0;">Connect your calendar to schedule meetings with your professional network.</p>
                                <button class="btn" style="background: #10b981; color: white; margin: 8px;">
                                    <i class="fas fa-google"></i> Connect Google Calendar
                                </button>
                                <button class="btn" style="background: #0078d4; color: white; margin: 8px;">
                                    <i class="fas fa-microsoft"></i> Connect Outlook
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            showLeads() {
                const modal = document.createElement('div');
                modal.className = 'overlay';
                modal.innerHTML = `
                    <div class="settings-modal" style="max-width: 600px;">
                        <div class="settings-header" style="background: #f59e0b; color: white;">
                            <h3><i class="fas fa-handshake"></i> Lead Management</h3>
                            <button class="close-btn" onclick="this.closest('.overlay').remove()" style="color: white;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="settings-content">
                            <div style="text-align: center; padding: 40px 20px;">
                                <i class="fas fa-chart-line" style="font-size: 64px; color: #f59e0b; margin-bottom: 20px;"></i>
                                <h3>Manage Business Leads</h3>
                                <p style="color: #6b7280; margin: 16px 0;">Track and manage your business opportunities and potential clients.</p>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin: 24px 0;">
                                    <div style="background: #fef3c7; padding: 16px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 24px; font-weight: 700; color: #f59e0b;">0</div>
                                        <div style="font-size: 12px; color: #6b7280;">New Leads</div>
                                    </div>
                                    <div style="background: #dbeafe; padding: 16px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 24px; font-weight: 700; color: #3b82f6;">0</div>
                                        <div style="font-size: 12px; color: #6b7280;">In Progress</div>
                                    </div>
                                    <div style="background: #f0fdf4; padding: 16px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 24px; font-weight: 700; color: #10b981;">0</div>
                                        <div style="font-size: 12px; color: #6b7280;">Closed</div>
                                    </div>
                                </div>
                                <button class="btn" style="background: #f59e0b; color: white;">
                                    <i class="fas fa-plus"></i> Add New Lead
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            async showNotifications() {
                let notifications = [];
                let joinRequests = [];
                let groupNotifications = [];
                
                if (isSupabaseEnabled) {
                    try {
                        // Get follow notifications
                        const { data: notificationData } = await supabase
                            .from('notifications')
                            .select('*')
                            .eq('user_id', this.currentUser.id)
                            .order('created_at', { ascending: false })
                            .limit(20);
                        
                        notifications = notificationData || [];
                        
                        // Get group notifications
                        const { data: groupNotificationData } = await supabase
                            .from('group_notifications')
                            .select('*')
                            .eq('user_id', this.currentUser.id)
                            .order('created_at', { ascending: false })
                            .limit(20);
                        
                        groupNotifications = groupNotificationData || [];
                        
                        // Get pending channel join requests for user's channels
                        const { data: requests } = await supabase
                            .from('channel_join_requests')
                            .select(`
                                *,
                                channels!inner(name, creator_id),
                                profiles!channel_join_requests_user_id_fkey(full_name, username)
                            `)
                            .eq('channels.creator_id', this.currentUser.id)
                            .eq('status', 'pending');
                        
                        joinRequests = requests || [];
                    } catch (error) {
                        console.error('Error loading notifications:', error);
                    }
                }
                
                const modal = document.createElement('div');
                modal.className = 'overlay';
                modal.innerHTML = `
                    <div class="settings-modal" style="max-width: 450px; max-height: 90vh;">
                        <div class="settings-header" style="background: #6366f1; color: white;">
                            <h3><i class="fas fa-bell"></i> Notifications</h3>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                ${notifications.filter(n => !n.read).length > 0 ? `
                                    <button onclick="window.authManager.markAllNotificationsRead()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">
                                        Mark all read
                                    </button>
                                ` : ''}
                                <button class="close-btn" onclick="this.closest('.overlay').remove()" style="color: white;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="settings-content" style="max-height: 70vh; overflow-y: auto;">
                            ${notifications.length > 0 ? `
                                <div style="margin-bottom: 20px;">
                                    <h4 style="margin-bottom: 12px; color: #374151; display: flex; align-items: center; gap: 8px;"><i class="fas fa-heart" style="color: #ef4444;"></i> Follow Notifications</h4>
                                    ${notifications.map(notification => `
                                        <div onclick="window.authManager.handleNotificationClick('${notification.id}', '${notification.data.follower_id}')" style="background: ${notification.read ? '#f8fafc' : '#eff6ff'}; padding: 16px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid ${notification.read ? '#e5e7eb' : '#3b82f6'}; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='${notification.read ? '#f1f5f9' : '#dbeafe'}'" onmouseout="this.style.background='${notification.read ? '#f8fafc' : '#eff6ff'}'">
                                            <div style="display: flex; align-items: center; gap: 12px;">
                                                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #1e40af, #06b6d4); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 16px; overflow: hidden; flex-shrink: 0;">
                                                    ${notification.data.follower_photo ? 
                                                        `<img src="${notification.data.follower_photo}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` :
                                                        (notification.data.follower_name || notification.data.follower_username).charAt(0).toUpperCase()
                                                    }
                                                </div>
                                                <div style="flex: 1; min-width: 0;">
                                                    <div style="font-weight: ${notification.read ? '500' : '600'}; color: #374151; margin-bottom: 2px; font-size: 14px;">
                                                        <span onclick="event.stopPropagation(); window.authManager.showUserProfile('${notification.data.follower_id}')" style="color: #1e40af; cursor: pointer; text-decoration: none; font-weight: 600;" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">${notification.data.follower_name}</span> started following you
                                                    </div>
                                                    <div style="font-size: 12px; color: #6b7280;">${this.formatNotificationTime(notification.created_at)}</div>
                                                </div>
                                                ${!notification.read ? `<div style="width: 8px; height: 8px; background: #3b82f6; border-radius: 50%; flex-shrink: 0;"></div>` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            
                            ${groupNotifications.length > 0 ? `
                                <div style="margin-bottom: 20px;">
                                    <h4 style="margin-bottom: 12px; color: #374151; display: flex; align-items: center; gap: 8px;"><i class="fas fa-users" style="color: #10b981;"></i> Group Notifications</h4>
                                    ${groupNotifications.map(notification => `
                                        <div onclick="window.authManager.handleGroupNotificationClick('${notification.id}', '${notification.group_id || notification.channel_id}', '${notification.notification_type}')" style="background: ${notification.read ? '#f8fafc' : '#f0fdf4'}; padding: 16px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid ${notification.read ? '#e5e7eb' : '#10b981'}; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='${notification.read ? '#f1f5f9' : '#dcfce7'}'" onmouseout="this.style.background='${notification.read ? '#f8fafc' : '#f0fdf4'}'">
                                            <div style="display: flex; align-items: center; gap: 12px;">
                                                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #10b981, #059669); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 16px; overflow: hidden; flex-shrink: 0;">
                                                    ${notification.data.adder_photo ? 
                                                        `<img src="${notification.data.adder_photo}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` :
                                                        (notification.data.adder_name || notification.data.adder_username).charAt(0).toUpperCase()
                                                    }
                                                </div>
                                                <div style="flex: 1; min-width: 0;">
                                                    <div style="font-weight: ${notification.read ? '500' : '600'}; color: #374151; margin-bottom: 2px; font-size: 14px;">
                                                        <span onclick="event.stopPropagation(); window.authManager.showUserProfile('${notification.added_by_user_id}')" style="color: #10b981; cursor: pointer; text-decoration: none; font-weight: 600;" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">${notification.data.adder_name}</span> added you to ${notification.notification_type === 'group_addition' ? 'group' : 'channel'} "${notification.data.group_name || notification.data.channel_name}"
                                                    </div>
                                                    <div style="font-size: 12px; color: #6b7280;">${this.formatNotificationTime(notification.created_at)}</div>
                                                </div>
                                                ${!notification.read ? `<div style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; flex-shrink: 0;"></div>` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            
                            ${joinRequests.length > 0 ? `
                                <div style="margin-bottom: 20px;">
                                    <h4 style="margin-bottom: 12px; color: #374151;">Channel Join Requests</h4>
                                    ${joinRequests.map(req => `
                                        <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #3b82f6;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                                <div>
                                                    <div style="font-weight: 600; color: #374151;">${req.profiles.full_name || req.profiles.username}</div>
                                                    <div style="font-size: 12px; color: #6b7280;">wants to join ${req.channels.name}</div>
                                                </div>
                                            </div>
                                            <div style="display: flex; gap: 8px;">
                                                <button class="btn" style="background: #10b981; color: white; padding: 6px 12px; font-size: 12px;" onclick="window.authManager.approveChannelRequest('${req.id}')">
                                                    <i class="fas fa-check"></i> Approve
                                                </button>
                                                <button class="btn" style="background: #ef4444; color: white; padding: 6px 12px; font-size: 12px;" onclick="window.authManager.rejectChannelRequest('${req.id}')">
                                                    <i class="fas fa-times"></i> Reject
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            
                            ${notifications.length === 0 && groupNotifications.length === 0 && joinRequests.length === 0 ? `
                                <div style="text-align: center; padding: 40px 20px;">
                                    <i class="fas fa-bell-slash" style="font-size: 48px; color: #d1d5db; margin-bottom: 16px;"></i>
                                    <h3>No New Notifications</h3>
                                    <p style="color: #6b7280;">Follow notifications and requests will appear here.</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Update notification badge
                this.updateNotificationBadge();
            }
            

            
            async showAccountStatus() {

                let totalUsers = 0;
                let followsCount = 0;
                let messagesCount = 0;
                let profileViews = { total_views: 0, today_views: 0, week_views: 0 };
                
                if (isSupabaseEnabled) {
                    try {
                        const [usersResult, followsResult, messagesResult, viewsResult] = await Promise.all([
                            supabase.from('profiles').select('id'),
                            supabase.from('follows').select('following_id').eq('follower_id', this.currentUser.id),
                            supabase.from('messages').select('id').eq('sender_id', this.currentUser.id),
                            supabase.rpc('get_profile_view_stats', { user_id: this.currentUser.id })
                        ]);
                        totalUsers = usersResult.data?.length || 0;
                        followsCount = followsResult.data?.length || 0;
                        messagesCount = messagesResult.data?.length || 0;
                        profileViews = viewsResult.data || { total_views: 0, today_views: 0, week_views: 0 };
                    } catch (error) {
                        console.error('Error getting real data:', error);
                    }
                }
                
                const modal = document.createElement('div');
                modal.className = 'overlay';
                modal.innerHTML = `
                    <div class="settings-modal" style="max-width: 500px; max-height: 90vh;">
                        <div class="settings-header" style="background: #3b82f6; color: white;">
                            <h3><i class="fas fa-chart-line"></i> Account Status</h3>
                            <button class="close-btn" onclick="this.closest('.overlay').remove()" style="color: white;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="settings-content" style="max-height: 70vh; overflow-y: auto;">
                            <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
                                <h4 style="margin-bottom: 16px; color: #374151;"><i class="fas fa-eye"></i> Profile Reach</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 16px;">
                                    <div style="background: white; padding: 16px; border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                        <div style="font-size: 28px; font-weight: 700; color: #3b82f6;">${profileViews.total_views}</div>
                                        <div style="font-size: 12px; color: #6b7280; text-transform: uppercase;">Total Views</div>
                                    </div>
                                    <div style="background: white; padding: 16px; border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                        <div style="font-size: 28px; font-weight: 700; color: #10b981;">${profileViews.week_views}</div>
                                        <div style="font-size: 12px; color: #6b7280; text-transform: uppercase;">This Week</div>
                                    </div>
                                    <div style="background: white; padding: 16px; border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                        <div style="font-size: 28px; font-weight: 700; color: #f59e0b;">${profileViews.today_views}</div>
                                        <div style="font-size: 12px; color: #6b7280; text-transform: uppercase;">Today</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: #ecfdf5; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #10b981;">
                                <h4 style="margin-bottom: 16px; color: #374151;"><i class="fas fa-users"></i> Real-Time Network</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px;">

                                    <div style="background: white; padding: 12px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 20px; font-weight: 700; color: #3b82f6;">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                                        <div style="font-size: 11px; color: #6b7280;">Current Time</div>
                                    </div>
                                    <div style="background: white; padding: 12px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 20px; font-weight: 700; color: #f59e0b;">Live</div>
                                        <div style="font-size: 11px; color: #6b7280;">Status</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            async loadInfluencerStatus() {
                try {
                    if (isSupabaseEnabled && this.currentUser) {
                        // Use new SQL function to check influencer status
                        const { data, error } = await supabase
                            .rpc('check_influencer_status', { user_id: this.currentUser.id });
                        
                        if (!error && data && data.length > 0) {
                            const userData = data[0];
                            this.currentUser.is_influencer_business = userData.is_influencer_business;
                            this.currentUser.influencer_activated_at = userData.influencer_activated_at;
                            
                            // Update localStorage with fresh data
                            localStorage.setItem('businessconnect_current_user', JSON.stringify(this.currentUser));
                        }
                    }
                    
                    // Apply UI updates with delay to ensure DOM is ready
                    setTimeout(() => this.checkInfluencerMode(), 200);
                    setTimeout(() => this.forceInfluencerUpdate(), 1000);
                } catch (error) {
                    console.error('Error loading influencer status:', error);
                    this.checkInfluencerMode();
                }
            }
            
            forceInfluencerUpdate() {
                if (this.currentUser && this.currentUser.is_influencer_business) {
                    console.log('Force updating influencer button state');
                    const influencerButtons = document.getElementById('influencerButtons');
                    if (influencerButtons) {
                        influencerButtons.style.display = 'flex';
                    }
                    this.updateInfluencerButton(true);
                }
            }
            
            checkInfluencerMode() {
                // Check multiple times to ensure DOM is ready
                const checkAndUpdate = () => {
                    if (this.currentUser && this.currentUser.is_influencer_business) {
                        const influencerButtons = document.getElementById('influencerButtons');
                        if (influencerButtons) {
                            influencerButtons.style.display = 'flex';
                        }
                        this.updateInfluencerButton(true);
                    }
                };
                
                setTimeout(checkAndUpdate, 100);
                setTimeout(checkAndUpdate, 500);
                setTimeout(checkAndUpdate, 1000);
            }
            
            updateInfluencerButton(isEnabled) {
                const btn = document.getElementById('influencerModeBtn');
                const text = document.getElementById('influencerModeText');
                const arrow = document.getElementById('influencerArrow');
                const enableOption = document.getElementById('enableInfluencerOption');
                const disableOption = document.getElementById('disableInfluencerOption');
                
                if (btn && text && arrow && enableOption && disableOption) {
                    if (isEnabled) {
                        text.innerHTML = '<i class="fas fa-circle" style="color: #10b981; font-size: 8px; margin-right: 4px;"></i>Influencer Business';
                        btn.querySelector('.hover-text').textContent = 'Influencer Business Options';
                        enableOption.style.display = 'none';
                        disableOption.style.display = 'block';
                    } else {
                        text.textContent = 'Influencer Business';
                        btn.querySelector('.hover-text').textContent = 'Enable Influencer Business Mode';
                        enableOption.style.display = 'block';
                        disableOption.style.display = 'none';
                    }
                    arrow.style.display = 'inline';
                    btn.style.background = '#8b5cf6';
                    btn.onclick = () => this.toggleInfluencerDropdown();
                }
            }
            
            async toggleInfluencerMode() {
                const isInfluencer = this.currentUser.is_influencer_business;
                
                if (isInfluencer) {
                    await this.disableInfluencerMode();
                } else {
                    await this.enableInfluencerMode();
                }
            }
            
            async enableInfluencerMode() {
                const btn = document.getElementById('influencerModeBtn');
                const text = document.getElementById('influencerModeText');
                const arrow = document.getElementById('influencerArrow');
                
                btn.disabled = true;
                btn.style.position = 'relative';
                
                // Add pulse animation
                btn.style.animation = 'pulse 1.5s infinite';
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes pulse {
                        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.7); }
                        70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(139, 92, 246, 0); }
                        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(139, 92, 246, 0); }
                    }
                `;
                document.head.appendChild(style);
                
                text.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Activating...';
                
                await new Promise(resolve => setTimeout(resolve, 5500));
                
                try {
                    if (isSupabaseEnabled) {
                        const { error } = await supabase
                            .from('profiles')
                            .update({ 
                                is_influencer_business: true,
                                influencer_activated_at: new Date().toISOString()
                            })
                            .eq('id', this.currentUser.id);
                        
                        if (error) throw error;
                    }
                    
                    this.currentUser.is_influencer_business = true;
                    this.currentUser.influencer_activated_at = new Date().toISOString();
                    localStorage.setItem('businessconnect_current_user', JSON.stringify(this.currentUser));
                    
                    btn.style.animation = 'none';
                    text.innerHTML = '<i class="fas fa-check"></i> Activated!';
                    btn.style.background = '#10b981';
                    
                    document.getElementById('influencerButtons').style.display = 'flex';
                    
                    setTimeout(() => {
                        btn.disabled = false;
                        this.updateInfluencerButton(true);
                    }, 2000);
                    
                    this.showNotification('🎉 Influencer Business mode activated!', 'success');
                    
                } catch (error) {
                    console.error('Error enabling influencer mode:', error);
                    btn.style.animation = 'none';
                    text.textContent = 'Enable';
                    btn.disabled = false;
                    this.showNotification('Failed to activate Influencer Business mode', 'error');
                }
            }
            
            toggleInfluencerDropdown() {
                const dropdown = document.getElementById('influencerDropdown');
                const arrow = document.getElementById('influencerArrow');
                
                if (dropdown.style.display === 'none') {
                    dropdown.style.display = 'block';
                    arrow.innerHTML = '<i class="fas fa-chevron-up"></i>';
                    
                    // Close dropdown when clicking outside
                    setTimeout(() => {
                        document.addEventListener('click', this.handleInfluencerOutsideClick.bind(this), { once: true });
                    }, 100);
                } else {
                    this.hideInfluencerDropdown();
                }
            }
            
            hideInfluencerDropdown() {
                const dropdown = document.getElementById('influencerDropdown');
                const arrow = document.getElementById('influencerArrow');
                dropdown.style.display = 'none';
                arrow.innerHTML = '<i class="fas fa-chevron-down"></i>';
            }
            
            handleInfluencerOutsideClick(event) {
                const dropdown = document.getElementById('influencerDropdown');
                const btn = document.getElementById('influencerModeBtn');
                
                if (dropdown && btn && !dropdown.contains(event.target) && !btn.contains(event.target)) {
                    this.hideInfluencerDropdown();
                }
            }
            
            async disableInfluencerMode() {
                try {
                    if (isSupabaseEnabled) {
                        const { error } = await supabase
                            .from('profiles')
                            .update({ is_influencer_business: false })
                            .eq('id', this.currentUser.id);
                        
                        if (error) throw error;
                    }
                    
                    this.currentUser.is_influencer_business = false;
                    localStorage.setItem('businessconnect_current_user', JSON.stringify(this.currentUser));
                    
                    document.getElementById('influencerButtons').style.display = 'none';
                    this.hideInfluencerDropdown();
                    
                    const btn = document.getElementById('influencerModeBtn');
                    const text = document.getElementById('influencerModeText');
                    const arrow = document.getElementById('influencerArrow');
                    this.updateInfluencerButton(false);
                    
                    this.showNotification('Influencer Business mode disabled', 'success');
                    
                } catch (error) {
                    console.error('Error disabling influencer mode:', error);
                    this.showNotification('Failed to disable Influencer Business mode', 'error');
                }
            }
            
            showUICustomization() {
                const modal = document.createElement('div');
                modal.className = 'overlay';
                modal.innerHTML = `
                    <div class="settings-modal" style="max-width: 400px;">
                        <div class="settings-header" style="background: #10b981; color: white;">
                            <h3><i class="fas fa-palette"></i> UI Customization</h3>
                            <button class="close-btn" onclick="this.closest('.overlay').remove()" style="color: white;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="settings-content">
                            <div style="text-align: center; padding: 20px;">
                                <i class="fas fa-paint-brush" style="font-size: 48px; color: #10b981; margin-bottom: 16px;"></i>
                                <h3>UI Theme Customization</h3>
                                <p style="color: #6b7280; margin: 16px 0;">Customize your interface colors and layout</p>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 20px 0;">
                                    <div onclick="window.authManager.applyTheme('blue')" style="background: linear-gradient(135deg, #1e40af, #3b82f6); height: 60px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">Blue</div>
                                    <div onclick="window.authManager.applyTheme('purple')" style="background: linear-gradient(135deg, #8b5cf6, #a855f7); height: 60px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">Purple</div>
                                    <div onclick="window.authManager.applyTheme('green')" style="background: linear-gradient(135deg, #10b981, #059669); height: 60px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">Green</div>
                                    <div onclick="window.authManager.applyTheme('orange')" style="background: linear-gradient(135deg, #f59e0b, #d97706); height: 60px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">Orange</div>
                                </div>
                                
                                <button class="btn" style="background: #6b7280; color: white; width: 100%;" onclick="window.authManager.resetTheme()">
                                    <i class="fas fa-undo"></i> Reset to Default
                                </button>
                                
                                <button class="btn" style="background: #8b5cf6; color: white; width: 100%; margin-top: 12px;" onclick="window.authManager.showGroupMembersManager()">
                                    <i class="fas fa-users"></i> View Members
                                </button>
                                
                                <button class="btn" style="background: #ef4444; color: white; width: 100%; margin-top: 12px;" onclick="window.groupLeaveManager.showLeaveGroupsModal(); this.closest('.overlay').remove();">
                                    <i class="fas fa-sign-out-alt"></i> Leave Groups
                                </button>
                                
                                <div id="chatLockFromUISection" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                                    <button class="btn" id="lockChatFromUIBtn" style="background: #f59e0b; color: white; width: 100%; margin-bottom: 12px;" onclick="window.authManager.toggleChatLockFromUI()">
                                        <i class="fas fa-lock"></i> <span id="lockChatFromUIText">Lock Current Chat</span>
                                    </button>
                                </div>
                                <div id="deleteChatFromUISection" style="display: none; margin-top: 12px;">
                                    <button class="btn" style="background: #ef4444; color: white; width: 100%;" onclick="window.authManager.deleteCurrentChatFromUI()">
                                        <i class="fas fa-trash"></i> Delete Current Chat
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Show delete chat button if in conversation
                setTimeout(() => {
                    if (window.chatManager && window.chatManager.currentConversation) {
                        const deleteChatSection = document.getElementById('deleteChatFromUISection');
                        if (deleteChatSection) {
                            deleteChatSection.style.display = 'block';
                        }
                    }
                }, 100);
            }
            
            applyTheme(theme) {
                const colors = {
                    blue: { primary: '#1e40af', secondary: '#3b82f6' },
                    purple: { primary: '#8b5cf6', secondary: '#a855f7' },
                    green: { primary: '#10b981', secondary: '#059669' },
                    orange: { primary: '#f59e0b', secondary: '#d97706' }
                };
                
                const color = colors[theme];
                if (color) {
                    const headers = document.querySelectorAll('.chat-header, .settings-header');
                    headers.forEach(header => {
                        header.style.background = `linear-gradient(135deg, ${color.primary}, ${color.secondary})`;
                    });
                    
                    localStorage.setItem('businessconnect_theme', theme);
                    this.showNotification(`${theme.charAt(0).toUpperCase() + theme.slice(1)} theme applied!`, 'success');
                    document.querySelector('.overlay').remove();
                }
            }
            
            resetTheme() {
                localStorage.removeItem('businessconnect_theme');
                location.reload();
            }
            
            showGroupMembersManager() {
                const modal = document.createElement('div');
                modal.className = 'overlay';
                modal.innerHTML = `
                    <div class="settings-modal" style="max-width: 500px; max-height: 90vh;">
                        <div class="settings-header" style="background: #8b5cf6; color: white;">
                            <h3><i class="fas fa-users"></i> Manage Members</h3>
                            <button class="close-btn" onclick="this.closest('.overlay').remove()" style="color: white;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="settings-content" style="max-height: 70vh; overflow-y: auto;">
                            <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                                <button class="btn" style="background: #10b981; color: white; flex: 1;" onclick="window.authManager.showMyCreatedGroups()">
                                    <i class="fas fa-users"></i> My Groups
                                </button>
                                <button class="btn" style="background: #f59e0b; color: white; flex: 1;" onclick="window.authManager.showMyCreatedChannels()">
                                    <i class="fas fa-broadcast-tower"></i> My Channels
                                </button>
                            </div>
                            <div id="membersContent" style="text-align: center; padding: 40px 20px; color: #6b7280;">
                                <i class="fas fa-users" style="font-size: 48px; margin-bottom: 16px;"></i>
                                <h3>Select Groups or Channels</h3>
                                <p>Choose to view members of your created groups or channels.</p>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            async showMyCreatedGroups() {
                const content = document.getElementById('membersContent');
                content.innerHTML = `
                    <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                        <button class="btn" id="createdGroupsTab" style="background: #10b981; color: white; flex: 1;" onclick="window.authManager.showCreatedGroups()">
                            <i class="fas fa-plus"></i> Created by Me
                        </button>
                        <button class="btn" id="joinedGroupsTab" style="background: #6b7280; color: white; flex: 1;" onclick="window.authManager.showJoinedGroups()">
                            <i class="fas fa-user-plus"></i> Added by Others
                        </button>
                    </div>
                    <div id="groupsTabContent">
                        <div style="text-align: center; padding: 40px 20px; color: #6b7280;">
                            <i class="fas fa-users" style="font-size: 48px; margin-bottom: 16px;"></i>
                            <h3>Select Tab</h3>
                            <p>Choose to view groups you created or groups you were added to.</p>
                        </div>
                    </div>
                `;
                
                // Auto-show created groups
                this.showCreatedGroups();
            }
            
            async showCreatedGroups() {
                try {
                    // Update tab styling
                    document.getElementById('createdGroupsTab').style.background = '#10b981';
                    document.getElementById('joinedGroupsTab').style.background = '#6b7280';
                    
                    const { data: groups, error } = await supabase
                        .from('groups')
                        .select('*')
                        .eq('creator_id', this.currentUser.id);
                    
                    if (error) throw error;
                    
                    const content = document.getElementById('groupsTabContent');
                    if (groups && groups.length > 0) {
                        content.innerHTML = groups.map(group => `
                            <div onclick="window.authManager.viewGroupMembers('${group.id}', '${group.name}')" style="display: flex; align-items: center; padding: 16px; background: #f0fdf4; border-radius: 12px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s; border-left: 4px solid #10b981;">
                                <div style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #10b981, #059669); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 18px; margin-right: 16px;">
                                    ${group.name.charAt(0).toUpperCase()}
                                </div>
                                <div style="flex: 1; text-align: left;">
                                    <div style="font-weight: 600; font-size: 16px; color: #1f2937; margin-bottom: 4px;">${group.name} <span style="background: #10b981; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">CREATOR</span></div>
                                    <div style="color: #6b7280; font-size: 14px;">${group.description || 'No description'}</div>
                                </div>
                                <i class="fas fa-chevron-right" style="color: #10b981;"></i>
                            </div>
                        `).join('');
                    } else {
                        content.innerHTML = `
                            <div style="text-align: center; padding: 40px 20px; color: #6b7280;">
                                <i class="fas fa-users" style="font-size: 48px; margin-bottom: 16px;"></i>
                                <h3>No Groups Created</h3>
                                <p>You haven't created any groups yet.</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Error loading created groups:', error);
                    this.showNotification('Failed to load groups', 'error');
                }
            }
            
            async showJoinedGroups() {
                try {
                    // Update tab styling
                    document.getElementById('createdGroupsTab').style.background = '#6b7280';
                    document.getElementById('joinedGroupsTab').style.background = '#10b981';
                    
                    // Get groups where user is a member but not creator
                    const { data: memberGroups, error } = await supabase
                        .from('group_members')
                        .select('group_id')
                        .eq('user_id', this.currentUser.id);
                    
                    if (error) throw error;
                    
                    const groupIds = memberGroups?.map(m => m.group_id) || [];
                    
                    if (groupIds.length === 0) {
                        document.getElementById('groupsTabContent').innerHTML = `
                            <div style="text-align: center; padding: 40px 20px; color: #6b7280;">
                                <i class="fas fa-user-plus" style="font-size: 48px; margin-bottom: 16px;"></i>
                                <h3>No Groups Joined</h3>
                                <p>You haven't been added to any groups yet.</p>
                            </div>
                        `;
                        return;
                    }
                    
                    const { data: groups, error: groupsError } = await supabase
                        .from('groups')
                        .select('*')
                        .in('id', groupIds)
                        .neq('creator_id', this.currentUser.id);
                    
                    if (groupsError) throw groupsError;
                    
                    const content = document.getElementById('groupsTabContent');
                    if (groups && groups.length > 0) {
                        content.innerHTML = groups.map(group => `
                            <div onclick="window.authManager.viewGroupMembers('${group.id}', '${group.name}')" style="display: flex; align-items: center; padding: 16px; background: #eff6ff; border-radius: 12px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s; border-left: 4px solid #3b82f6;">
                                <div style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #3b82f6, #1d4ed8); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 18px; margin-right: 16px;">
                                    ${group.name.charAt(0).toUpperCase()}
                                </div>
                                <div style="flex: 1; text-align: left;">
                                    <div style="font-weight: 600; font-size: 16px; color: #1f2937; margin-bottom: 4px;">${group.name} <span style="background: #3b82f6; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">MEMBER</span></div>
                                    <div style="color: #6b7280; font-size: 14px;">${group.description || 'No description'}</div>
                                </div>
                                <i class="fas fa-chevron-right" style="color: #3b82f6;"></i>
                            </div>
                        `).join('');
                    } else {
                        content.innerHTML = `
                            <div style="text-align: center; padding: 40px 20px; color: #6b7280;">
                                <i class="fas fa-user-plus" style="font-size: 48px; margin-bottom: 16px;"></i>
                                <h3>No Groups Joined</h3>
                                <p>You haven't been added to any groups by others yet.</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Error loading joined groups:', error);
                    this.showNotification('Failed to load joined groups', 'error');
                }
            }
            
            async showMyCreatedChannels() {
                try {
                    // Only show channels created by the user (not joined ones)
                    const { data: channels, error } = await supabase
                        .from('channels')
                        .select('*')
                        .eq('creator_id', this.currentUser.id);
                    
                    if (error) throw error;
                    
                    const content = document.getElementById('membersContent');
                    if (channels && channels.length > 0) {
                        content.innerHTML = channels.map(channel => `
                            <div onclick="window.authManager.viewChannelMembers('${channel.id}', '${channel.name}')" style="display: flex; align-items: center; padding: 16px; background: #fef3c7; border-radius: 12px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s; border-left: 4px solid #f59e0b;">
                                <div style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #f59e0b, #d97706); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 18px; margin-right: 16px;">
                                    ${channel.name.charAt(0).toUpperCase()}
                                </div>
                                <div style="flex: 1; text-align: left;">
                                    <div style="font-weight: 600; font-size: 16px; color: #1f2937; margin-bottom: 4px;">${channel.name} <span style="background: #f59e0b; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">CREATOR</span></div>
                                    <div style="color: #6b7280; font-size: 14px;">${channel.description || 'No description'}</div>
                                </div>
                                <i class="fas fa-chevron-right" style="color: #f59e0b;"></i>
                            </div>
                        `).join('');
                    } else {
                        content.innerHTML = `
                            <div style="text-align: center; padding: 40px 20px; color: #6b7280;">
                                <i class="fas fa-broadcast-tower" style="font-size: 48px; margin-bottom: 16px;"></i>
                                <h3>No Channels Created</h3>
                                <p>You haven't created any channels yet.</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Error loading created channels:', error);
                    this.showNotification('Failed to load channels', 'error');
                }
            }
            
            async viewGroupMembers(groupId, groupName) {
                try {
                    // Get group members with profiles using join
                    const { data: members, error } = await supabase
                        .from('group_members')
                        .select(`
                            user_id,
                            profiles!group_members_user_id_fkey(
                                id,
                                full_name,
                                username,
                                profile_photo,
                                job_title,
                                company
                            )
                        `)
                        .eq('group_id', groupId);
                    
                    if (error) throw error;
                    
                    const memberProfiles = members?.map(member => member.profiles).filter(Boolean) || [];
                    
                    this.displayMembersModal(memberProfiles, groupName, 'group', groupId);
                    
                } catch (error) {
                    console.error('Error loading group members:', error);
                    this.showNotification('Failed to load group members', 'error');
                }
            }
            
            async viewChannelMembers(channelId, channelName) {
                try {
                    const { data: members, error } = await supabase
                        .from('channel_members')
                        .select('user_id')
                        .eq('channel_id', channelId);
                    
                    if (error) throw error;
                    
                    const memberProfiles = [];
                    for (let member of members || []) {
                        const { data: profile } = await supabase
                            .from('profiles')
                            .select('*')
                            .eq('id', member.user_id)
                            .single();
                        if (profile) memberProfiles.push(profile);
                    }
                    
                    this.displayMembersModal(memberProfiles, channelName, 'channel', null, channelId);
                    
                } catch (error) {
                    console.error('Error loading channel members:', error);
                    this.showNotification('Failed to load channel members', 'error');
                }
            }
            
            displayMembersModal(members, name, type, groupId = null, channelId = null) {
                const modal = document.createElement('div');
                modal.className = 'overlay';
                modal.innerHTML = `
                    <div class="settings-modal" style="max-width: 500px; max-height: 90vh;">
                        <div class="settings-header" style="background: ${type === 'group' ? '#10b981' : '#f59e0b'}; color: white;">
                            <h3><i class="fas fa-${type === 'group' ? 'users' : 'broadcast-tower'}"></i> ${name} Members</h3>
                            <button class="close-btn" onclick="this.closest('.overlay').remove()" style="color: white;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="settings-content" style="max-height: 70vh; overflow-y: auto;">
                            ${members.length === 0 ? `
                                <div style="text-align: center; padding: 40px 20px; color: #6b7280;">
                                    <i class="fas fa-users" style="font-size: 48px; margin-bottom: 16px;"></i>
                                    <h3>No Members Found</h3>
                                    <p>This ${type} has no members yet.</p>
                                </div>
                            ` : `
                                ${members.map(member => `
                                    <div style="display: flex; align-items: center; gap: 16px; padding: 16px; background: #f8fafc; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid ${type === 'group' ? '#10b981' : '#f59e0b'};">
                                        <div style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, ${type === 'group' ? '#10b981, #059669' : '#f59e0b, #d97706'}); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 18px; overflow: hidden;">
                                            ${member.profile_photo ? 
                                                `<img src="${member.profile_photo}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` :
                                                (member.full_name || member.username).charAt(0).toUpperCase()
                                            }
                                        </div>
                                        <div style="flex: 1; min-width: 0;">
                                            <div style="font-weight: 600; font-size: 16px; color: #1f2937; margin-bottom: 4px;">${member.full_name || member.username}</div>
                                            <div style="color: #6b7280; font-size: 14px; margin-bottom: 4px;">@${member.username}</div>
                                            ${member.job_title ? `<div style="color: ${type === 'group' ? '#10b981' : '#f59e0b'}; font-size: 12px; font-weight: 500;"><i class="fas fa-briefcase"></i> ${member.job_title}</div>` : ''}
                                        </div>
                                        <div style="display: flex; flex-direction: column; gap: 8px;">
                                            ${member.id !== this.currentUser.id ? `
                                                <button onclick="window.authManager.checkMessageLockAndStart('${member.id}'); this.closest('.overlay').remove();" style="background: ${type === 'group' ? '#10b981' : '#f59e0b'}; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                                    <i class="fas fa-comment"></i> Message
                                                </button>
                                                <button onclick="window.groupMemberManager.showRemoveConfirmation('${member.full_name || member.username}', '${name}', '${groupId || channelId}', '${member.id}', '${type}')" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                                    <i class="fas fa-user-minus"></i> Remove
                                                </button>
                                            ` : `
                                                <div style="background: #f3f4f6; color: #6b7280; padding: 8px 16px; border-radius: 6px; font-size: 12px; font-weight: 600;">
                                                    <i class="fas fa-crown"></i> Creator
                                                </div>
                                            `}
                                        </div>
                                    </div>
                                `).join('')}
                            `}
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            async toggleFollowFromProfile(userId) {
                const btn = document.getElementById(`profileFollowBtn_${userId}`);
                const isCurrentlyFollowing = btn.textContent.trim() === 'Unfollow';
                
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                
                try {
                    if (isCurrentlyFollowing) {
                        // Unfollow
                        await supabase
                            .from('follows')
                            .delete()
                            .eq('follower_id', this.currentUser.id)
                            .eq('following_id', userId);
                        
                        btn.innerHTML = '<i class="fas fa-user-plus"></i> Follow';
                        btn.style.background = '#10b981';
                    } else {
                        // Follow
                        await supabase
                            .from('follows')
                            .insert({
                                follower_id: this.currentUser.id,
                                following_id: userId
                            });
                        
                        btn.innerHTML = '<i class="fas fa-user-minus"></i> Unfollow';
                        btn.style.background = '#ef4444';
                    }
                    
                    btn.disabled = false;
                    this.loadHomeFeed();
                    
                } catch (error) {
                    console.error('Toggle follow error:', error);
                    btn.disabled = false;
                    btn.innerHTML = isCurrentlyFollowing ? '<i class="fas fa-user-minus"></i> Unfollow' : '<i class="fas fa-user-plus"></i> Follow';
                }
            }
            
            showInfluencerBusiness() {
                this.showMyGroups();
            }



            
            async getConversationsList() {
                if (!isSupabaseEnabled) return '<div class="welcome-message"><i class="fas fa-comments"></i><h3>No conversations yet</h3><p>Start messaging your connections</p></div>';
                
                try {
                    const { data: messages, error } = await supabase
                        .from('messages')
                        .select('*')
                        .or(`sender_id.eq.${this.currentUser.id},conversation_id.like.%${this.currentUser.id}%`)
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    
                    const conversations = new Map();
                    
                    for (const message of messages) {
                        const conversationId = message.conversation_id;
                        if (!conversations.has(conversationId)) {
                            const otherUserId = this.getOtherUserIdFromConversation(conversationId);
                            const { data: otherUser } = await supabase
                                .from('profiles')
                                .select('*')
                                .eq('id', otherUserId)
                                .single();
                            
                            const unreadCount = await this.getUnreadMessageCount(otherUserId);
                            
                            conversations.set(conversationId, {
                                user: otherUser,
                                lastMessage: message,
                                unreadCount
                            });
                        }
                    }
                    
                    if (conversations.size === 0) {
                        return '<div class="welcome-message"><i class="fas fa-comments"></i><h3>No conversations yet</h3><p>Start messaging your connections</p></div>';
                    }
                    
                    return Array.from(conversations.values()).map(conv => {
                        const user = conv.user;
                        const lastMsg = conv.lastMessage;
                        const unreadCount = conv.unreadCount;
                        const time = new Date(lastMsg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        
                        return `
                            <div class="conversation-item" onclick="window.chatManager.startConversation('${user.id}')" style="display: flex; align-items: center; gap: 16px; padding: 16px; background: white; border-radius: 12px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; border-left: 4px solid ${unreadCount > 0 ? '#1e40af' : 'transparent'};">
                                <div style="position: relative;">
                                    <div style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #1e40af, #06b6d4); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 18px;">
                                        ${user.profile_photo ? 
                                            `<img src="${user.profile_photo}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` :
                                            (user.full_name || user.username).charAt(0).toUpperCase()
                                        }
                                    </div>
                                    ${unreadCount > 0 ? `<div style="position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; font-weight: 600; display: flex; align-items: center; justify-content: center; border: 2px solid white;">${unreadCount}</div>` : ''}
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                        <div style="font-weight: ${unreadCount > 0 ? '700' : '600'}; font-size: 16px; color: #1f2937;">${user.full_name || user.username}</div>
                                        <div style="font-size: 12px; color: #6b7280;">${time}</div>
                                    </div>
                                    <div style="font-size: 14px; color: ${unreadCount > 0 ? '#374151' : '#6b7280'}; font-weight: ${unreadCount > 0 ? '500' : '400'}; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                        ${lastMsg.sender_id === this.currentUser.id ? 'You: ' : ''}${lastMsg.type === 'file' ? '📎 ' + lastMsg.file_name : lastMsg.text}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                } catch (error) {
                    console.error('Error loading conversations:', error);
                    return '<div class="welcome-message"><i class="fas fa-exclamation-triangle"></i><h3>Error loading messages</h3><p>Please refresh the page</p></div>';
                }
            }
            
            getOtherUserIdFromConversation(conversationId) {
                const userIds = conversationId.split('_');
                return userIds.find(id => id !== this.currentUser.id);
            }
            

            
            getConversationId(userId1, userId2) {
                return [userId1, userId2].sort().join('_');
            }
            
            getLastReadTime(conversationId) {
                if (!conversationId || !this.currentUser) return new Date(0).toISOString();
                
                const key = `lastRead_${this.currentUser.id}_${conversationId}`;
                const lastRead = localStorage.getItem(key);
                return lastRead || new Date(0).toISOString();
            }
            
            async markConversationAsRead(conversationId) {
                if (!conversationId || !isSupabaseEnabled) return;
                
                try {
                    await supabase.rpc('update_message_read_status', {
                        p_user_id: this.currentUser.id,
                        p_conversation_id: conversationId
                    });
                    
                    // Trigger immediate home feed refresh
                    setTimeout(() => {
                        this.loadHomeFeed();
                    }, 100);
                } catch (error) {
                    console.error('Error marking conversation as read:', error);
                }
            }
            
            goBackToHomeFeed() {
                // Mark current conversation as read before going back
                if (window.chatManager && window.chatManager.currentConversation) {
                    const conversationId = window.chatManager.currentConversation.conversationId;
                    this.markConversationAsRead(conversationId);
                    
                    // Clean up chat manager
                    window.chatManager.cleanup();
                }
                
                // Show home feed and hide chat
                const homeFeed = document.getElementById('homeFeed');
                const businessTools = document.getElementById('businessTools');
                const chatMessages = document.getElementById('chatMessages');
                const chatInputContainer = document.getElementById('chatInputContainer');
                const backBtn = document.getElementById('backBtn');
                const chatTitle = document.getElementById('chatTitle');
                const chatStatus = document.getElementById('chatStatus');
                
                if (homeFeed) homeFeed.style.display = 'block';
                if (businessTools) businessTools.style.display = 'none';
                if (chatMessages) chatMessages.style.display = 'none';
                if (chatInputContainer) chatInputContainer.style.display = 'none';
                if (backBtn) backBtn.style.display = 'none';
                
                // Reset header
                if (chatTitle) chatTitle.textContent = 'BusinessConnect';
                if (chatStatus) chatStatus.innerHTML = '';
                
                // Reset URL to home state
                if (window.location.hash) {
                    history.replaceState(null, '', window.location.pathname);
                }
                
                // Force refresh home feed to show updated unread counts
                setTimeout(() => {
                    this.loadHomeFeed();
                }, 100);
            }
            

            

            

            
            async showJoinedGroups() {
                let groups = [];
                
                if (isSupabaseEnabled) {
                    try {
                        // Get groups where user is a member
                        const { data: memberGroups, error } = await supabase
                            .from('group_members')
                            .select('group_id')
                            .eq('user_id', this.currentUser.id);
                        
                        if (error) throw error;
                        
                        const groupIds = memberGroups?.map(m => m.group_id) || [];
                        
                        if (groupIds.length > 0) {
                            // Get group details with creator info
                            const { data: groupsData, error: groupsError } = await supabase
                                .from('groups')
                                .select(`
                                    id,
                                    name,
                                    description,
                                    creator_id,
                                    profiles!groups_creator_id_fkey(full_name, username)
                                `)
                                .in('id', groupIds);
                            
                            if (!groupsError && groupsData) {
                                groups = groupsData.map(group => ({
                                    group_id: group.id,
                                    group_name: group.name,
                                    group_description: group.description,
                                    creator_name: group.profiles?.full_name || group.profiles?.username || 'Unknown'
                                }));
                            }
                        }
                    } catch (error) {
                        console.error('Error loading joined groups:', error);
                    }
                }
                
                const modal = document.createElement('div');
                modal.className = 'overlay';
                modal.innerHTML = `
                    <div class="settings-modal" style="max-width: 500px; max-height: 90vh;">
                        <div class="settings-header" style="background: #3b82f6; color: white;">
                            <h3><i class="fas fa-user-plus"></i> Joined Groups</h3>
                            <button class="close-btn" onclick="this.closest('.overlay').remove();" style="color: white;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="settings-content" style="max-height: 70vh; overflow-y: auto;">
                            ${groups.length === 0 ? `
                                <div style="text-align: center; padding: 40px 20px; color: #6b7280;">
                                    <i class="fas fa-users" style="font-size: 48px; margin-bottom: 16px;"></i>
                                    <h3>No Joined Groups</h3>
                                    <p>You haven't been added to any groups yet.</p>
                                </div>
                            ` : `
                                ${groups.map(group => `
                                    <div onclick="window.groupChatManager.openGroup('${group.group_id}'); this.closest('.overlay').remove();" style="display: flex; align-items: center; padding: 16px; background: #eff6ff; border-radius: 12px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s; border-left: 4px solid #3b82f6;">
                                        <div style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #3b82f6, #1d4ed8); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 18px; margin-right: 16px;">
                                            ${group.group_name.charAt(0).toUpperCase()}
                                        </div>
                                        <div style="flex: 1; text-align: left;">
                                            <div style="font-weight: 600; font-size: 16px; color: #1f2937; margin-bottom: 4px;">${group.group_name} <span style="background: #3b82f6; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">MEMBER</span></div>
                                            <div style="color: #6b7280; font-size: 14px; margin-bottom: 4px;">${group.group_description || 'No description'}</div>
                                            <div style="font-size: 12px; color: #6b7280;">Added by ${group.creator_name}</div>
                                        </div>
                                        <i class="fas fa-chevron-right" style="color: #3b82f6;"></i>
                                    </div>
                                `).join('')}
                            `}
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            async showJoinedChannels() {
                let channels = [];
                
                if (isSupabaseEnabled) {
                    try {
                        const { data, error } = await supabase
                            .rpc('get_user_joined_channels', { user_id_param: this.currentUser.id });
                        
                        if (error) throw error;
                        channels = data || [];
                    } catch (error) {
                        console.error('Error loading joined channels:', error);
                    }
                }
                
                const modal = document.createElement('div');
                modal.className = 'overlay';
                modal.innerHTML = `
                    <div class="settings-modal" style="max-width: 500px; max-height: 90vh;">
                        <div class="settings-header" style="background: #8b5cf6; color: white;">
                            <h3><i class="fas fa-satellite-dish"></i> Joined Channels</h3>
                            <button class="close-btn" onclick="document.body.style.overflow='auto'; this.closest('.overlay').remove();" style="color: white;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="settings-content" style="max-height: 70vh; overflow-y: auto;">
                            ${channels.length === 0 ? `
                                <div style="text-align: center; padding: 40px 20px; color: #6b7280;">
                                    <i class="fas fa-broadcast-tower" style="font-size: 48px; margin-bottom: 16px;"></i>
                                    <h3>No Joined Channels</h3>
                                    <p>You haven't been added to any channels yet.</p>
                                </div>
                            ` : `
                                ${channels.map(channel => `
                                    <div class="channel-item" onclick="window.authManager.openChannel('${channel.channel_id}')" style="display: flex; align-items: center; padding: 16px; background: #f8fafc; border-radius: 12px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s; border-left: 4px solid #8b5cf6;">
                                        <div style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #8b5cf6, #a855f7); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 18px; margin-right: 16px;">
                                            ${channel.channel_name.charAt(0).toUpperCase()}
                                        </div>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; font-size: 16px; color: #1f2937; margin-bottom: 4px;">${channel.channel_name}</div>
                                            <div style="color: #6b7280; font-size: 14px; margin-bottom: 4px;">${channel.channel_description || 'No description'}</div>
                                            <div style="font-size: 12px; color: #6b7280;">Added by ${channel.creator_name}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            `}
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            showSearchModal() {
                const modal = document.createElement('div');
                modal.className = 'overlay';
                modal.innerHTML = `
                    <div class="settings-modal" style="max-width: 600px; max-height: 90vh;">
                        <div class="settings-header" style="background: #1e40af; color: white;">
                            <h3><i class="fas fa-search"></i> Find Professionals</h3>
                            <button class="close-btn" onclick="this.closest('.overlay').remove();" style="color: white;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div style="padding: 20px; border-bottom: 1px solid #e5e7eb;">
                            <div style="position: relative;">
                                <input type="text" id="modalSearchInput" placeholder="Search by name, username, or email..." style="width: 100%; padding: 12px 16px; padding-right: 40px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                <button id="clearSearchBtn" onclick="window.authManager.clearModalSearch()" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #6b7280; cursor: pointer; padding: 4px; display: none;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div id="modalSearchResults" style="max-height: 60vh; overflow-y: auto; padding: 20px;">
                            <div style="text-align: center; color: #6b7280; padding: 40px 20px;">
                                <i class="fas fa-search" style="font-size: 48px; margin-bottom: 16px;"></i>
                                <h3>Start Your Search</h3>
                                <p>Type to search for professionals</p>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Setup real-time search
                const searchInput = document.getElementById('modalSearchInput');
                const clearBtn = document.getElementById('clearSearchBtn');
                let searchTimeout;
                
                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.trim();
                    
                    // Show/hide clear button
                    clearBtn.style.display = query ? 'block' : 'none';
                    
                    // Clear previous timeout
                    clearTimeout(searchTimeout);
                    
                    if (query.length === 0) {
                        this.showInitialSearchState();
                        return;
                    }
                    
                    // Search immediately for any character
                    searchTimeout = setTimeout(() => {
                        this.performRealTimeSearch(query);
                    }, 200);
                });
                
                // Focus input
                setTimeout(() => searchInput.focus(), 100);
            }
            
            async performRealTimeSearch(query) {
                const resultsContainer = document.getElementById('modalSearchResults');
                
                // Show loading for any query
                resultsContainer.innerHTML = `
                    <div style="text-align: center; color: #6b7280; padding: 20px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 12px;"></i>
                        <p>Searching...</p>
                    </div>
                `;
                
                try {
                    let users = [];
                    
                    if (isSupabaseEnabled) {
                        // Use the new active users search function
                        
                        // Direct search in profiles table
                        const { data, error } = await supabase
                            .from('profiles')
                            .select('*')
                            .or(`username.ilike.%${query}%,full_name.ilike.%${query}%,email.ilike.%${query}%`)
                            .neq('id', this.currentUser?.id || '00000000-0000-0000-0000-000000000000')
                            .limit(15);
                        
                        if (error) throw error;
                        users = data || [];
                    } else {
                        // Fallback to cached users
                        const cachedUsers = JSON.parse(localStorage.getItem('businessconnect_all_users') || '[]');
                        users = cachedUsers.filter(user => 
                            user.id !== this.currentUser.id &&
                            (user.username?.toLowerCase().includes(query.toLowerCase()) ||
                             user.full_name?.toLowerCase().includes(query.toLowerCase()) ||
                             user.email?.toLowerCase().includes(query.toLowerCase()))
                        ).slice(0, 15);
                    }
                    
                    this.displayModalSearchResults(users, query);
                } catch (error) {
                    console.error('Search error:', error);
                    
                    // Try fallback search with cached data
                    try {
                        const cachedUsers = JSON.parse(localStorage.getItem('businessconnect_all_users') || '[]');
                        const fallbackUsers = cachedUsers.filter(user => 
                            user.id !== this.currentUser.id &&
                            (user.username?.toLowerCase().includes(query.toLowerCase()) ||
                             user.full_name?.toLowerCase().includes(query.toLowerCase()) ||
                             user.email?.toLowerCase().includes(query.toLowerCase()))
                        ).slice(0, 15);
                        
                        if (fallbackUsers.length > 0) {
                            this.displayModalSearchResults(fallbackUsers, query);
                            return;
                        }
                    } catch (fallbackError) {
                        console.error('Fallback search error:', fallbackError);
                    }
                    
                    resultsContainer.innerHTML = `
                        <div style="text-align: center; color: #6b7280; padding: 20px;">
                            <i class="fas fa-wifi" style="font-size: 32px; margin-bottom: 12px; color: #ef4444;"></i>
                            <h3>Connection Issue</h3>
                            <p>Unable to search at the moment. Please check your connection and try again.</p>
                            <button onclick="window.authManager.performRealTimeSearch('${query}')" style="background: #1e40af; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-top: 12px;">
                                <i class="fas fa-refresh"></i> Retry Search
                            </button>
                        </div>
                    `;
                }
            }
            
            displayModalSearchResults(users, query = '') {
                const resultsContainer = document.getElementById('modalSearchResults');
                
                if (!users || users.length === 0) {
                    resultsContainer.innerHTML = `
                        <div style="text-align: center; color: #6b7280; padding: 40px 20px;">
                            <i class="fas fa-user-slash" style="font-size: 48px; margin-bottom: 16px;"></i>
                            <h3>No Results Found</h3>
                            <p>No users found for "${query}"</p>
                        </div>
                    `;
                    return;
                }
                
                resultsContainer.innerHTML = users.map(user => `
                    <div style="display: flex; align-items: center; gap: 16px; padding: 16px; background: #f8fafc; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid #1e40af; transition: all 0.2s; cursor: pointer;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='#f8fafc'">
                        <div style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #1e40af, #06b6d4); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 18px; overflow: hidden;">
                            ${user.profile_photo ? 
                                `<img src="${user.profile_photo}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` :
                                (user.full_name || user.username).charAt(0).toUpperCase()
                            }
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; font-size: 16px; color: #1f2937; margin-bottom: 4px;">${user.full_name || user.username}</div>
                            <div style="color: #6b7280; font-size: 14px; margin-bottom: 4px;">@${user.username}</div>
                            ${user.job_title ? `<div style="color: #1e40af; font-size: 12px; font-weight: 500;"><i class="fas fa-briefcase"></i> ${user.job_title}</div>` : ''}
                            ${user.bio ? `<div style="color: #4b5563; font-size: 12px; margin-top: 4px; line-height: 1.4; max-height: 32px; overflow: hidden;">${user.bio}</div>` : ''}
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <button onclick="window.authManager.checkMessageLockAndStart('${user.id}')" style="background: #1e40af; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#1d4ed8'" onmouseout="this.style.background='#1e40af'">
                                <i class="fas fa-comment"></i> Message
                            </button>
                            <button onclick="window.authManager.followUserFromSearch('${user.id}')" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                                <i class="fas fa-user-plus"></i> Follow
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            clearModalSearch() {
                const searchInput = document.getElementById('modalSearchInput');
                const clearBtn = document.getElementById('clearSearchBtn');
                
                searchInput.value = '';
                clearBtn.style.display = 'none';
                searchInput.focus();
                
                this.showInitialSearchState();
            }
            
            showInitialSearchState() {
                document.getElementById('modalSearchResults').innerHTML = `
                    <div style="text-align: center; color: #6b7280; padding: 40px 20px;">
                        <i class="fas fa-search" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <h3>Start Your Search</h3>
                        <p>Type to search for professionals</p>
                    </div>
                `;
            }
            
            async startChatFromSearch(userId) {
                document.querySelector('.overlay').remove();
                this.checkMessageLockAndStart(userId);
            }
            
            async followUserFromSearch(userId) {
                try {
                    if (isSupabaseEnabled) {
                        const { error } = await supabase
                            .from('follows')
                            .insert({
                                follower_id: this.currentUser.id,
                                following_id: userId
                            });
                        
                        if (error) {
                            if (error.code === '23505') {
                                this.showNotification('You are already following this user', 'error');
                            } else {
                                throw error;
                            }
                            return;
                        }
                        
                        // Notification will be automatically created by the database trigger
                    }
                    
                    this.showNotification('User followed successfully!', 'success');
                    this.loadHomeFeed();
                    
                } catch (error) {
                    console.error('Follow error:', error);
                    this.showNotification('Failed to follow user', 'error');
                }
            }
            
            getUserStatusColor() {
                return '#22c55e';
            }
            
            toggleChatLockFromUI() {
                if (!window.chatManager || !window.chatManager.currentConversation || !window.chatLockManager) return;
                
                const conversationId = window.chatManager.currentConversation.conversationId;
                const isLocked = window.chatLockManager.isChatLocked(conversationId);
                
                if (isLocked) {
                    window.chatLockManager.unlockChat(conversationId);
                    this.showNotification('Chat unlocked', 'success');
                } else {
                    const success = window.chatLockManager.lockChat(conversationId);
                    if (success) {
                        this.showNotification('Chat locked', 'success');
                    } else {
                        return; // Password modal will be shown
                    }
                }
                
                // Update button state immediately
                setTimeout(() => {
                    const lockBtn = document.getElementById('lockChatFromUIBtn');
                    const lockText = document.getElementById('lockChatFromUIText');
                    if (lockBtn && lockText) {
                        const newIsLocked = window.chatLockManager.isChatLocked(conversationId);
                        lockBtn.style.background = newIsLocked ? '#ef4444' : '#f59e0b';
                        lockText.textContent = newIsLocked ? 'Unlock Current Chat' : 'Lock Current Chat';
                    }
                }, 100);
            }
            
            showChatOptions(userId, userName) {
                const modal = document.createElement('div');
                modal.className = 'overlay';
                modal.innerHTML = `
                    <div class="settings-modal" style="max-width: 300px;">
                        <div class="settings-header" style="background: #ef4444; color: white;">
                            <h3><i class="fas fa-user"></i> ${userName}</h3>
                            <button class="close-btn" onclick="this.closest('.overlay').remove()" style="color: white;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="settings-content" style="padding: 20px;">
                            <button class="btn" style="background: #ef4444; color: white; width: 100%; margin-bottom: 12px;" onclick="window.authManager.confirmDeleteChat('${userId}', '${userName}')">
                                <i class="fas fa-trash"></i> Delete Chat
                            </button>
                            <button class="btn" style="background: #6b7280; color: white; width: 100%;" onclick="this.closest('.overlay').remove()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            confirmDeleteChat(userId, userName) {
                const modal = document.createElement('div');
                modal.className = 'overlay';
                modal.innerHTML = `
                    <div class="settings-modal" style="max-width: 350px;">
                        <div class="settings-header" style="background: #ef4444; color: white;">
                            <h3><i class="fas fa-exclamation-triangle"></i> Delete Chat</h3>
                        </div>
                        <div class="settings-content" style="padding: 20px; text-align: center;">
                            <p style="margin-bottom: 20px; color: #374151;">Delete entire conversation with <strong>${userName}</strong>?</p>
                            <p style="margin-bottom: 20px; font-size: 14px; color: #6b7280;">This will permanently delete all messages in this conversation.</p>
                            <div style="display: flex; gap: 12px;">
                                <button class="btn" style="background: #ef4444; color: white; flex: 1;" onclick="window.authManager.executeDeleteChat('${userId}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                                <button class="btn" style="background: #6b7280; color: white; flex: 1;" onclick="this.closest('.overlay').remove()">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Remove previous modal
                const prevModal = document.querySelectorAll('.overlay');
                if (prevModal.length > 1) {
                    prevModal[0].remove();
                }
            }
            
            async executeDeleteChat(userId) {
                const conversationId = [this.currentUser.id, userId].sort().join('_');
                document.querySelector('.overlay').remove();
                await this.deleteChatForMe(conversationId);
            }
            
            confirmDeleteChatFromProfile(userId, userName) {
                const modal = document.createElement('div');
                modal.className = 'overlay';
                modal.innerHTML = `
                    <div class="settings-modal" style="max-width: 350px;">
                        <div class="settings-header" style="background: #ef4444; color: white;">
                            <h3><i class="fas fa-exclamation-triangle"></i> Delete Chat</h3>
                        </div>
                        <div class="settings-content" style="padding: 20px; text-align: center;">
                            <p style="margin-bottom: 20px; color: #374151;">Delete entire conversation with <strong>${userName}</strong>?</p>
                            <p style="margin-bottom: 20px; font-size: 14px; color: #6b7280;">This will permanently delete all messages in this conversation.</p>
                            <div style="display: flex; gap: 12px;">
                                <button class="btn" style="background: #ef4444; color: white; flex: 1;" onclick="window.authManager.executeDeleteChatFromProfile('${userId}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                                <button class="btn" style="background: #6b7280; color: white; flex: 1;" onclick="this.closest('.overlay').remove()">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            async executeDeleteChatFromProfile(userId) {
                const conversationId = [this.currentUser.id, userId].sort().join('_');
                document.querySelector('.overlay').remove();
                await this.deleteChatForMe(conversationId);
            }
            
            async openGroup(groupId) {
                this.showNotification('Opening group...', 'success');
                // Close the modal
                const overlay = document.querySelector('.overlay');
                if (overlay) overlay.remove();
                
                // Start group chat using the group chat manager
                if (window.groupChatManager) {
                    await window.groupChatManager.startGroupChat(groupId);
                } else {
                    console.error('Group chat manager not available');
                    this.showNotification('Group chat not available', 'error');
                }
            }
            
            async openChannel(channelId) {
                this.showNotification('Opening channel...', 'success');
                // Close the modal
                document.querySelector('.overlay').remove();
                // Channel functionality would be implemented here
                console.log('Opening channel:', channelId);
            }
            
            async showMyGroups() {
                let groups = [];
                
                if (isSupabaseEnabled) {
                    try {
                        const { data, error } = await supabase
                            .from('groups')
                            .select('*')
                            .eq('creator_id', this.currentUser.id);
                        
                        if (error) throw error;
                        groups = data || [];
                    } catch (error) {
                        console.error('Error loading my groups:', error);
                    }
                }
                
                const modal = document.createElement('div');
                modal.className = 'overlay';
                modal.innerHTML = `
                    <div class="settings-modal" style="max-width: 500px; max-height: 90vh;">
                        <div class="settings-header" style="background: #10b981; color: white;">
                            <h3><i class="fas fa-users"></i> My Groups</h3>
                            <button class="close-btn" onclick="this.closest('.overlay').remove();" style="color: white;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="settings-content" style="max-height: 70vh; overflow-y: auto;">
                            <div style="margin-bottom: 16px;">
                                <button class="btn" style="background: #10b981; color: white; width: 100%;" onclick="window.authManager.showCreateGroup()">
                                    <i class="fas fa-plus"></i> Create New Group
                                </button>
                            </div>
                            ${groups.length === 0 ? `
                                <div style="text-align: center; padding: 40px 20px; color: #6b7280;">
                                    <i class="fas fa-users" style="font-size: 48px; margin-bottom: 16px;"></i>
                                    <h3>No Groups Created</h3>
                                    <p>Create your first group to get started.</p>
                                </div>
                            ` : `
                                ${groups.map(group => `
                                    <div onclick="window.authManager.openGroup('${group.id}')" style="display: flex; align-items: center; padding: 16px; background: #f8fafc; border-radius: 12px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s; border-left: 4px solid #10b981;">
                                        <div style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #10b981, #059669); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 18px; margin-right: 16px;">
                                            ${group.name.charAt(0).toUpperCase()}
                                        </div>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; font-size: 16px; color: #1f2937; margin-bottom: 4px;">${group.name}</div>
                                            <div style="color: #6b7280; font-size: 14px;">${group.description || 'No description'}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            `}
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            async showMyChannels() {
                let channels = [];
                
                if (isSupabaseEnabled) {
                    try {
                        const { data, error } = await supabase
                            .from('channels')
                            .select('*')
                            .eq('creator_id', this.currentUser.id);
                        
                        if (error) throw error;
                        channels = data || [];
                    } catch (error) {
                        console.error('Error loading my channels:', error);
                    }
                }
                
                const modal = document.createElement('div');
                modal.className = 'overlay';
                modal.innerHTML = `
                    <div class="settings-modal" style="max-width: 500px; max-height: 90vh;">
                        <div class="settings-header" style="background: #f59e0b; color: white;">
                            <h3><i class="fas fa-broadcast-tower"></i> My Channels</h3>
                            <button class="close-btn" onclick="this.closest('.overlay').remove();" style="color: white;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="settings-content" style="max-height: 70vh; overflow-y: auto;">
                            <div style="margin-bottom: 16px;">
                                <button class="btn" style="background: #f59e0b; color: white; width: 100%;" onclick="window.authManager.showCreateChannel()">
                                    <i class="fas fa-plus"></i> Create New Channel
                                </button>
                            </div>
                            ${channels.length === 0 ? `
                                <div style="text-align: center; padding: 40px 20px; color: #6b7280;">
                                    <i class="fas fa-broadcast-tower" style="font-size: 48px; margin-bottom: 16px;"></i>
                                    <h3>No Channels Created</h3>
                                    <p>Create your first channel to get started.</p>
                                </div>
                            ` : `
                                ${channels.map(channel => `
                                    <div onclick="window.authManager.openChannel('${channel.id}')" style="display: flex; align-items: center; padding: 16px; background: #f8fafc; border-radius: 12px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s; border-left: 4px solid #f59e0b;">
                                        <div style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #f59e0b, #d97706); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 18px; margin-right: 16px;">
                                            ${channel.name.charAt(0).toUpperCase()}
                                        </div>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; font-size: 16px; color: #1f2937; margin-bottom: 4px;">${channel.name}</div>
                                            <div style="color: #6b7280; font-size: 14px;">${channel.description || 'No description'}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            `}
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            toggleGroupsChannelsDropdown() {
                const dropdown = document.getElementById('groupsChannelsDropdown');
                if (dropdown) {
                    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
                }
            }
            
            hideGroupsChannelsDropdown() {
                const dropdown = document.getElementById('groupsChannelsDropdown');
                if (dropdown) {
                    dropdown.style.display = 'none';
                }
            }
            
            showChatOptionsFromHeader() {
                if (window.chatManager && window.chatManager.currentConversation) {
                    const user = window.chatManager.currentConversation.user;
                    this.showChatOptions(user.id, user.full_name || user.username);
                }
            }
            
            showChatSettingsFromHeader() {
                if (window.chatManager && window.chatManager.currentConversation && window.chatSettings) {
                    const user = window.chatManager.currentConversation.user;
                    const conversationId = window.chatManager.currentConversation.conversationId;
                    window.chatSettings.showChatSettings(conversationId, user.full_name || user.username);
                }
            }
            
            showDeleteChatInSettings() {
                const deleteChatSection = document.getElementById('deleteChatSection');
                if (deleteChatSection && window.chatManager && window.chatManager.currentConversation) {
                    deleteChatSection.style.display = 'block';
                }
            }
            
            hideDeleteChatInSettings() {
                const deleteChatSection = document.getElementById('deleteChatSection');
                if (deleteChatSection) {
                    deleteChatSection.style.display = 'none';
                }
            }
            
            deleteCurrentChat() {
                if (window.chatManager && window.chatManager.currentConversation) {
                    const user = window.chatManager.currentConversation.user;
                    const conversationId = window.chatManager.currentConversation.conversationId;
                    
                    // Close settings modal first
                    const settingsOverlay = document.getElementById('settingsOverlay');
                    if (settingsOverlay) settingsOverlay.remove();
                    
                    // Show confirmation dialog
                    this.confirmDeleteCurrentChat(user.id, user.full_name || user.username);
                }
            }
            
            confirmDeleteCurrentChat(userId, userName) {
                const modal = document.createElement('div');
                modal.className = 'overlay';
                modal.innerHTML = `
                    <div class="settings-modal" style="max-width: 350px;">
                        <div class="settings-header" style="background: #ef4444; color: white;">
                            <h3><i class="fas fa-exclamation-triangle"></i> Delete Chat</h3>
                        </div>
                        <div class="settings-content" style="padding: 20px; text-align: center;">
                            <p style="margin-bottom: 20px; color: #374151;">Delete entire conversation with <strong>${userName}</strong>?</p>
                            <p style="margin-bottom: 20px; font-size: 14px; color: #6b7280;">This will permanently delete all messages in this conversation.</p>
                            <div style="display: flex; gap: 12px;">
                                <button class="btn" style="background: #ef4444; color: white; flex: 1;" onclick="window.authManager.executeDeleteCurrentChat('${userId}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                                <button class="btn" style="background: #6b7280; color: white; flex: 1;" onclick="this.closest('.overlay').remove()">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            async executeDeleteCurrentChat(userId) {
                const conversationId = [this.currentUser.id, userId].sort().join('_');
                document.querySelector('.overlay').remove();
                
                try {
                    // Save deleted conversation to database first
                    if (isSupabaseEnabled) {
                        await supabase
                            .from('deleted_conversations')
                            .insert({
                                user_id: this.currentUser.id,
                                conversation_id: conversationId,
                                other_user_id: userId,
                                deleted_at: new Date().toISOString()
                            });
                    }
                    
                    // Delete messages from database
                    const { error } = await supabase
                        .from('messages')
                        .delete()
                        .eq('conversation_id', conversationId);
                    
                    if (error) throw error;
                    
                    this.showNotification('Chat deleted successfully', 'success');
                    
                    // Go back to home feed
                    if (window.chatManager) {
                        window.chatManager.cleanup();
                    }
                    this.goBackToHomeFeed();
                    
                } catch (error) {
                    console.error('Error deleting chat:', error);
                    this.showNotification('Failed to delete chat', 'error');
                }
            }
            
            deleteCurrentChatFromUI() {
                if (window.chatManager && window.chatManager.currentConversation) {
                    const user = window.chatManager.currentConversation.user;
                    
                    // Close UI customization modal first
                    document.querySelector('.overlay').remove();
                    
                    // Show confirmation dialog
                    this.confirmDeleteCurrentChatFromUI(user.id, user.full_name || user.username);
                }
            }
            
            confirmDeleteCurrentChatFromUI(userId, userName) {
                const modal = document.createElement('div');
                modal.className = 'overlay';
                modal.innerHTML = `
                    <div class="settings-modal" style="max-width: 350px;">
                        <div class="settings-header" style="background: #ef4444; color: white;">
                            <h3><i class="fas fa-exclamation-triangle"></i> Delete Chat</h3>
                        </div>
                        <div class="settings-content" style="padding: 20px; text-align: center;">
                            <p style="margin-bottom: 20px; color: #374151;">Delete entire conversation with <strong>${userName}</strong>?</p>
                            <p style="margin-bottom: 20px; font-size: 14px; color: #6b7280;">This will permanently delete all messages and save the deletion record.</p>
                            <div style="display: flex; gap: 12px;">
                                <button class="btn" style="background: #ef4444; color: white; flex: 1;" onclick="window.authManager.executeDeleteCurrentChatFromUI('${userId}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                                <button class="btn" style="background: #6b7280; color: white; flex: 1;" onclick="this.closest('.overlay').remove()">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            async executeDeleteCurrentChatFromUI(userId) {
                const conversationId = [this.currentUser.id, userId].sort().join('_');
                document.querySelector('.overlay').remove();
                
                try {
                    // Save deleted conversation to database first
                    if (isSupabaseEnabled) {
                        await supabase
                            .from('deleted_conversations')
                            .insert({
                                user_id: this.currentUser.id,
                                conversation_id: conversationId,
                                other_user_id: userId,
                                deleted_at: new Date().toISOString()
                            });
                    }
                    
                    // Delete messages from database
                    const { error } = await supabase
                        .from('messages')
                        .delete()
                        .eq('conversation_id', conversationId);
                    
                    if (error) throw error;
                    
                    // Clear chat UI immediately
                    const chatMessages = document.getElementById('chatMessages');
                    if (chatMessages) {
                        chatMessages.innerHTML = '<div style="text-align: center; padding: 40px; color: #667781;">Chat deleted</div>';
                    }
                    
                    this.showNotification('Chat deleted and saved to database', 'success');
                    
                    // Go back to home feed after delay
                    setTimeout(() => {
                        if (window.chatManager) {
                            window.chatManager.cleanup();
                        }
                        this.goBackToHomeFeed();
                    }, 1000);
                    
                } catch (error) {
                    console.error('Error deleting chat:', error);
                    this.showNotification('Failed to delete chat', 'error');
                }
            }
            
            getUserStatusText() {
                return 'Active';
            }
            
            async testAddUserToGroup() {
                const userId = document.getElementById('testUserId')?.value.trim();
                const groupId = document.getElementById('testGroupId')?.value;
                
                if (!userId || !groupId) {
                    this.showNotification('Please enter User ID and select a Group', 'error');
                    return;
                }
                
                if (window.groupChatManager) {
                    const success = await window.groupChatManager.addUserToGroup(groupId, userId);
                    if (success) {
                        document.getElementById('testUserId').value = '';
                        document.getElementById('testGroupId').value = '';
                    }
                }
            }
            
            checkMessageLockAndStart(userId) {
                console.log('Checking message lock for user:', userId);
                console.log('Lock manager available:', !!window.lockManager);
                
                if (!window.lockManager) {
                    console.log('Lock manager not available, starting conversation normally');
                    if (window.chatManager) {
                        window.chatManager.startConversation(userId);
                    }
                    return;
                }
                
                const isLocked = window.lockManager.isFeatureLocked('messages');
                const isUnlocked = window.lockManager.isFeatureUnlocked('messages');
                
                console.log('Messages locked:', isLocked);
                console.log('Messages temporarily unlocked:', isUnlocked);
                
                // Check if messages feature is locked
                if (isLocked && !isUnlocked) {
                    console.log('Showing unlock modal');
                    window.lockManager.showUnlockModal('messages', userId);
                    return;
                }
                
                console.log('Starting conversation normally');
                // If not locked or temporarily unlocked, start conversation normally
                if (window.chatManager) {
                    window.chatManager.startConversation(userId);
                }
            }
            
            async deleteChatForMe(conversationId) {
                if (!isSupabaseEnabled || !this.currentUser) return;
                
                try {
                    // Delete all messages in this conversation
                    const { error } = await supabase
                        .from('messages')
                        .delete()
                        .eq('conversation_id', conversationId);
                    
                    if (error) throw error;
                    
                    // Clear chat UI immediately
                    const chatMessages = document.getElementById('chatMessages');
                    if (chatMessages) {
                        chatMessages.innerHTML = '<div style="text-align: center; padding: 40px; color: #667781;">Chat deleted</div>';
                    }
                    
                    this.showNotification('Chat deleted', 'success');
                    
                    // Go back to home feed after delay
                    setTimeout(() => {
                        if (window.chatManager) {
                            window.chatManager.cleanup();
                        }
                        this.goBackToHomeFeed();
                    }, 1000);
                    
                } catch (error) {
                    console.error('Error deleting chat:', error);
                    this.showNotification('Failed to delete chat', 'error');
                }
            }




            

            

            

            
            async updateNotificationBadge() {
                if (!isSupabaseEnabled || !this.currentUser) return;
                
                try {
                    // Get follow notifications count
                    const { data: followCount } = await supabase
                        .rpc('get_unread_notification_count', { user_id: this.currentUser.id });
                    
                    // Get group notifications count
                    let groupCount = 0;
                    if (window.groupNotificationManager) {
                        groupCount = await window.groupNotificationManager.getUnreadGroupNotificationsCount(this.currentUser.id);
                    }
                    
                    const totalCount = (followCount || 0) + (groupCount || 0);
                    
                    const badge = document.getElementById('notificationBadge');
                    const notificationBtn = document.getElementById('notificationsBtn');
                    
                    if (badge && notificationBtn) {
                        if (totalCount > 0) {
                            badge.textContent = totalCount > 99 ? '99+' : totalCount;
                            badge.style.display = 'flex';
                            notificationBtn.style.animation = 'shake 0.5s ease-in-out infinite';
                        } else {
                            badge.style.display = 'none';
                            notificationBtn.style.animation = 'none';
                        }
                    }
                } catch (error) {
                    console.error('Error updating notification badge:', error);
                    const notificationBtn = document.getElementById('notificationsBtn');
                    if (notificationBtn) {
                        notificationBtn.style.animation = 'none';
                    }
                }
            }
            
            async handleNotificationClick(notificationId, followerId) {
                // Mark notification as read
                if (isSupabaseEnabled) {
                    try {
                        await supabase
                            .rpc('mark_notification_read', { 
                                notification_id: notificationId, 
                                user_id: this.currentUser.id 
                            });
                    } catch (error) {
                        console.error('Error marking notification as read:', error);
                    }
                }
                
                // Stop shake animation
                const notificationBtn = document.getElementById('notificationsBtn');
                if (notificationBtn) {
                    notificationBtn.style.animation = 'none';
                }
                
                // Close notifications modal
                document.querySelector('.overlay').remove();
                
                // Show user profile
                this.showUserProfile(followerId);
                
                // Update notification badge
                this.updateNotificationBadge();
            }
            
            async handleGroupNotificationClick(notificationId, groupOrChannelId, notificationType) {
                // Mark group notification as read
                if (isSupabaseEnabled && window.groupNotificationManager) {
                    try {
                        await window.groupNotificationManager.markGroupNotificationRead(notificationId, this.currentUser.id);
                    } catch (error) {
                        console.error('Error marking group notification as read:', error);
                    }
                }
                
                // Close notifications modal
                document.querySelector('.overlay').remove();
                
                // Open the group or channel
                if (notificationType === 'group_addition') {
                    if (window.groupChatManager) {
                        window.groupChatManager.openGroup(groupOrChannelId);
                    }
                } else if (notificationType === 'channel_addition') {
                    if (window.groupChatManager) {
                        window.groupChatManager.openChannel(groupOrChannelId);
                    }
                }
                
                // Update notification badge
                this.updateNotificationBadge();
            }
            
            async handleNotificationClick(notificationId, followerId) {
                // Mark notification as read
                if (isSupabaseEnabled) {
                    try {
                        await supabase
                            .rpc('mark_notification_read', { 
                                notification_id: notificationId, 
                                user_id: this.currentUser.id 
                            });
                    } catch (error) {
                        console.error('Error marking notification as read:', error);
                    }
                }
                
                // Close notifications modal
                document.querySelector('.overlay').remove();
                
                // Show follower's profile
                this.showUserProfile(followerId);
                
                // Update badge
                this.updateNotificationBadge();
            }
            
            async markAllNotificationsRead() {
                if (!isSupabaseEnabled || !this.currentUser) return;
                
                try {
                    await supabase
                        .rpc('mark_all_notifications_read', { user_id: this.currentUser.id });
                    
                    // Stop shake animation
                    const notificationBtn = document.getElementById('notificationsBtn');
                    if (notificationBtn) {
                        notificationBtn.style.animation = 'none';
                    }
                    
                    this.showNotification('All notifications marked as read', 'success');
                    
                    // Refresh notifications modal
                    document.querySelector('.overlay').remove();
                    this.showNotifications();
                    
                    // Update badge
                    this.updateNotificationBadge();
                } catch (error) {
                    console.error('Error marking all notifications as read:', error);
                    this.showNotification('Failed to mark notifications as read', 'error');
                }
            }
            
            formatNotificationTime(timestamp) {
                const now = new Date();
                const time = new Date(timestamp);
                const diffMs = now - time;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                if (diffMins < 1) return 'Just now';
                if (diffMins < 60) return `${diffMins}m ago`;
                if (diffHours < 24) return `${diffHours}h ago`;
                if (diffDays < 7) return `${diffDays}d ago`;
                return time.toLocaleDateString();
            }

            showCreateGroup() {
                document.body.style.overflow = 'hidden';
                const modal = document.createElement('div');
                modal.className = 'overlay';
                modal.innerHTML = `
                    <div class="settings-modal" style="max-width: 400px;">
                        <div class="settings-header" style="background: #10b981; color: white;">
                            <h3><i class="fas fa-users"></i> Create Group</h3>
                            <button class="close-btn" onclick="document.body.style.overflow='auto'; this.closest('.overlay').remove();" style="color: white;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="settings-content">
                            <div class="setting-item" style="flex-direction: column; align-items: flex-start; margin-bottom: 16px;">
                                <label>Group Name</label>
                                <input type="text" id="groupName" class="setting-input" style="width: 100%; max-width: none;" placeholder="Enter group name">
                            </div>
                            <div class="setting-item" style="flex-direction: column; align-items: flex-start; margin-bottom: 16px;">
                                <label>Description</label>
                                <textarea id="groupDescription" class="setting-input" style="width: 100%; max-width: none; min-height: 60px;" placeholder="Group description (optional)"></textarea>
                            </div>
                            <div class="setting-item" style="margin-bottom: 16px;">
                                <label>Private Group</label>
                                <input type="checkbox" id="groupPrivate">
                            </div>
                            <button class="btn" style="background: #10b981; color: white; width: 100%;" onclick="window.authManager.createGroup()">
                                <i class="fas fa-plus"></i> Create Group
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            showCreateChannel() {
                document.body.style.overflow = 'hidden';
                const modal = document.createElement('div');
                modal.className = 'overlay';
                modal.innerHTML = `
                    <div class="settings-modal" style="max-width: 400px;">
                        <div class="settings-header" style="background: #f59e0b; color: white;">
                            <h3><i class="fas fa-broadcast-tower"></i> Create Channel</h3>
                            <button class="close-btn" onclick="document.body.style.overflow='auto'; this.closest('.overlay').remove();" style="color: white;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="settings-content">
                            <div class="setting-item" style="flex-direction: column; align-items: flex-start; margin-bottom: 16px;">
                                <label>Channel Name</label>
                                <input type="text" id="channelName" class="setting-input" style="width: 100%; max-width: none;" placeholder="Enter channel name">
                            </div>
                            <div class="setting-item" style="flex-direction: column; align-items: flex-start; margin-bottom: 16px;">
                                <label>Description</label>
                                <textarea id="channelDescription" class="setting-input" style="width: 100%; max-width: none; min-height: 60px;" placeholder="Channel description (optional)"></textarea>
                            </div>
                            <div class="setting-item" style="margin-bottom: 16px;">
                                <label>Private Channel</label>
                                <input type="checkbox" id="channelPrivate">
                            </div>
                            <button class="btn" style="background: #f59e0b; color: white; width: 100%;" onclick="window.authManager.createChannel()">
                                <i class="fas fa-plus"></i> Create Channel
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            async createGroup() {
                const name = document.getElementById('groupName').value.trim();
                const description = document.getElementById('groupDescription').value.trim();
                const isPrivate = document.getElementById('groupPrivate').checked;
                
                if (!name) {
                    this.showNotification('Group name is required', 'error');
                    return;
                }
                
                try {
                    if (isSupabaseEnabled) {
                        const { data, error } = await supabase
                            .from('groups')
                            .insert({
                                name,
                                description,
                                creator_id: this.currentUser.id,
                                is_private: isPrivate
                            })
                            .select()
                            .single();
                        
                        if (error) throw error;
                        
                        // Add creator as admin
                        await supabase
                            .from('group_members')
                            .insert({
                                group_id: data.id,
                                user_id: this.currentUser.id,
                                role: 'admin'
                            });
                    }
                    
                    this.showNotification('Group created successfully!', 'success');
                    document.body.style.overflow = 'auto';
                    document.querySelector('.overlay').remove();
                    
                    // Refresh home feed to show new group
                    this.loadHomeFeed();
                } catch (error) {
                    console.error('Error creating group:', error);
                    this.showNotification('Failed to create group', 'error');
                }
            }
            
            async createChannel() {
                const name = document.getElementById('channelName').value.trim();
                const description = document.getElementById('channelDescription').value.trim();
                const isPrivate = document.getElementById('channelPrivate').checked;
                
                if (!name) {
                    this.showNotification('Channel name is required', 'error');
                    return;
                }
                
                try {
                    if (isSupabaseEnabled) {
                        const { data, error } = await supabase
                            .from('channels')
                            .insert({
                                name,
                                description,
                                creator_id: this.currentUser.id,
                                is_private: isPrivate,
                                requires_approval: true
                            })
                            .select()
                            .single();
                        
                        if (error) throw error;
                        
                        // Add creator as admin
                        await supabase
                            .from('channel_members')
                            .insert({
                                channel_id: data.id,
                                user_id: this.currentUser.id,
                                role: 'admin'
                            });
                    }
                    
                    this.showNotification('Channel created successfully!', 'success');
                    document.body.style.overflow = 'auto';
                    document.querySelector('.overlay').remove();
                } catch (error) {
                    console.error('Error creating channel:', error);
                    this.showNotification('Failed to create channel', 'error');
                }
            }
            
            async approveChannelRequest(requestId) {
                try {
                    if (isSupabaseEnabled) {
                        const { error } = await supabase
                            .from('channel_join_requests')
                            .update({
                                status: 'approved',
                                reviewed_at: new Date().toISOString(),
                                reviewed_by: this.currentUser.id
                            })
                            .eq('id', requestId);
                        
                        if (error) throw error;
                    }
                    
                    this.showNotification('Request approved!', 'success');
                    document.querySelector('.overlay').remove();
                    this.showNotifications();
                } catch (error) {
                    console.error('Error approving request:', error);
                    this.showNotification('Failed to approve request', 'error');
                }
            }
            
            async rejectChannelRequest(requestId) {
                try {
                    if (isSupabaseEnabled) {
                        const { error } = await supabase
                            .from('channel_join_requests')
                            .update({
                                status: 'rejected',
                                reviewed_at: new Date().toISOString(),
                                reviewed_by: this.currentUser.id
                            })
                            .eq('id', requestId);
                        
                        if (error) throw error;
                    }
                    
                    this.showNotification('Request rejected', 'success');
                    document.querySelector('.overlay').remove();
                    this.showNotifications();
                } catch (error) {
                    console.error('Error rejecting request:', error);
                    this.showNotification('Failed to reject request', 'error');
                }
            }
            
            async showAddUsersToGroup(groupId) {
                document.body.style.overflow = 'hidden';
                
                // Get group info
                let group = null;
                if (isSupabaseEnabled) {
                    try {
                        const { data } = await supabase
                            .from('groups')
                            .select('*')
                            .eq('id', groupId)
                            .single();
                        group = data;
                    } catch (error) {
                        console.error('Error loading group:', error);
                    }
                }
                
                const modal = document.createElement('div');
                modal.className = 'overlay';
                modal.innerHTML = `
                    <div class="settings-modal" style="max-width: 400px; max-height: 90vh; display: flex; flex-direction: column;">
                        <div class="settings-header" style="background: #10b981; color: white; flex-shrink: 0;">
                            <h3><i class="fas fa-user-plus"></i> Add Users to ${group ? group.name : 'Group'}</h3>
                            <button class="close-btn" onclick="document.body.style.overflow='auto'; this.closest('.overlay').remove();" style="color: white;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div style="padding: 16px; border-bottom: 1px solid #e5e7eb; flex-shrink: 0;">
                            <div style="position: relative;">
                                <input type="text" id="userSearchInput" placeholder="Search users by name or username..." style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                <i class="fas fa-search" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #6b7280;"></i>
                            </div>
                        </div>
                        <div id="userSearchResults" style="flex: 1; overflow-y: auto; padding: 16px;">
                            <div style="text-align: center; color: #6b7280; padding: 20px;">
                                <i class="fas fa-search" style="font-size: 32px; margin-bottom: 12px;"></i>
                                <p>Search for users to add to the group</p>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Setup search functionality
                const searchInput = document.getElementById('userSearchInput');
                let searchTimeout;
                
                searchInput.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    const query = e.target.value.trim();
                    
                    if (query.length < 2) {
                        document.getElementById('userSearchResults').innerHTML = `
                            <div style="text-align: center; color: #6b7280; padding: 20px;">
                                <i class="fas fa-search" style="font-size: 32px; margin-bottom: 12px;"></i>
                                <p>Search for users to add to the group</p>
                            </div>
                        `;
                        return;
                    }
                    
                    searchTimeout = setTimeout(() => {
                        this.searchUsersForGroup(query, groupId);
                    }, 300);
                });
                
                // Close on overlay click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.style.overflow = 'auto';
                        modal.remove();
                    }
                });
            }
            
            async searchUsersForGroup(query, groupId) {
                const resultsContainer = document.getElementById('userSearchResults');
                
                try {
                    let users = [];
                    
                    if (isSupabaseEnabled) {
                        // Get users not already in the group
                        const { data: allUsers } = await supabase
                            .from('profiles')
                            .select('*')
                            .or(`username.ilike.%${query}%,full_name.ilike.%${query}%`)
                            .neq('id', this.currentUser.id)
                            .limit(10);
                        
                        // Filter out users already in group
                        const { data: groupMembers } = await supabase
                            .from('group_members')
                            .select('user_id')
                            .eq('group_id', groupId);
                        
                        const memberIds = groupMembers ? groupMembers.map(m => m.user_id) : [];
                        users = allUsers ? allUsers.filter(u => !memberIds.includes(u.id)) : [];
                    }
                    
                    if (users.length === 0) {
                        resultsContainer.innerHTML = `
                            <div style="text-align: center; color: #6b7280; padding: 20px;">
                                <i class="fas fa-user-slash" style="font-size: 32px; margin-bottom: 12px;"></i>
                                <p>No users found or all users are already in the group</p>
                            </div>
                        `;
                        return;
                    }
                    
                    resultsContainer.innerHTML = users.map(user => `
                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8fafc; border-radius: 8px; margin-bottom: 8px; border: 1px solid #e5e7eb;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #1e40af, #06b6d4); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 16px;">
                                ${user.profile_photo ? 
                                    `<img src="${user.profile_photo}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` :
                                    (user.full_name || user.username).charAt(0).toUpperCase()
                                }
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 600; font-size: 14px; color: #1f2937;">${user.full_name || user.username}</div>
                                <div style="font-size: 12px; color: #6b7280;">@${user.username}</div>
                                ${user.job_title ? `<div style="font-size: 12px; color: #1e40af;">${user.job_title}</div>` : ''}
                            </div>
                            <button onclick="window.authManager.addUserToGroup('${groupId}', '${user.id}', this)" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 12px; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-plus"></i> Add
                            </button>
                        </div>
                    `).join('');
                    
                } catch (error) {
                    console.error('Error searching users:', error);
                    resultsContainer.innerHTML = `
                        <div style="text-align: center; color: #ef4444; padding: 20px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 12px;"></i>
                            <p>Error searching users. Please try again.</p>
                        </div>
                    `;
                }
            }
            
            async addUserToGroup(groupId, userId, buttonElement) {
                try {
                    if (isSupabaseEnabled) {
                        const { error } = await supabase
                            .from('group_members')
                            .insert({
                                group_id: groupId,
                                user_id: userId,
                                role: 'member'
                            });
                        
                        if (error) throw error;
                    }
                    
                    // Update button to show success
                    buttonElement.innerHTML = '<i class="fas fa-check"></i> Added';
                    buttonElement.style.background = '#6b7280';
                    buttonElement.disabled = true;
                    
                    this.showNotification('User added to group successfully!', 'success');
                } catch (error) {
                    console.error('Error adding user to group:', error);
                    this.showNotification('Failed to add user to group', 'error');
                }
            }
            
            async showAddUsersToChannel(channelId) {
                document.body.style.overflow = 'hidden';
                
                // Get channel info
                let channel = null;
                if (isSupabaseEnabled) {
                    try {
                        const { data } = await supabase
                            .from('channels')
                            .select('*')
                            .eq('id', channelId)
                            .single();
                        channel = data;
                    } catch (error) {
                        console.error('Error loading channel:', error);
                    }
                }
                
                const modal = document.createElement('div');
                modal.className = 'overlay';
                modal.innerHTML = `
                    <div class="settings-modal" style="max-width: 400px; max-height: 90vh; display: flex; flex-direction: column;">
                        <div class="settings-header" style="background: #f59e0b; color: white; flex-shrink: 0;">
                            <h3><i class="fas fa-user-plus"></i> Add Users to ${channel ? channel.name : 'Channel'}</h3>
                            <button class="close-btn" onclick="document.body.style.overflow='auto'; this.closest('.overlay').remove();" style="color: white;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div style="padding: 16px; border-bottom: 1px solid #e5e7eb; flex-shrink: 0;">
                            <div style="position: relative;">
                                <input type="text" id="channelUserSearchInput" placeholder="Search users by name or username..." style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                <i class="fas fa-search" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #6b7280;"></i>
                            </div>
                        </div>
                        <div id="channelUserSearchResults" style="flex: 1; overflow-y: auto; padding: 16px;">
                            <div style="text-align: center; color: #6b7280; padding: 20px;">
                                <i class="fas fa-search" style="font-size: 32px; margin-bottom: 12px;"></i>
                                <p>Search for users to add to the channel</p>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Setup search functionality
                const searchInput = document.getElementById('channelUserSearchInput');
                let searchTimeout;
                
                searchInput.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    const query = e.target.value.trim();
                    
                    if (query.length < 2) {
                        document.getElementById('channelUserSearchResults').innerHTML = `
                            <div style="text-align: center; color: #6b7280; padding: 20px;">
                                <i class="fas fa-search" style="font-size: 32px; margin-bottom: 12px;"></i>
                                <p>Search for users to add to the channel</p>
                            </div>
                        `;
                        return;
                    }
                    
                    searchTimeout = setTimeout(() => {
                        this.searchUsersForChannel(query, channelId);
                    }, 300);
                });
                
                // Close on overlay click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.style.overflow = 'auto';
                        modal.remove();
                    }
                });
            }
            
            async searchUsersForChannel(query, channelId) {
                const resultsContainer = document.getElementById('channelUserSearchResults');
                
                try {
                    let users = [];
                    
                    if (isSupabaseEnabled) {
                        // Get users not already in the channel
                        const { data: allUsers } = await supabase
                            .from('profiles')
                            .select('*')
                            .or(`username.ilike.%${query}%,full_name.ilike.%${query}%`)
                            .neq('id', this.currentUser.id)
                            .limit(10);
                        
                        // Filter out users already in channel
                        const { data: channelMembers } = await supabase
                            .from('channel_members')
                            .select('user_id')
                            .eq('channel_id', channelId);
                        
                        const memberIds = channelMembers ? channelMembers.map(m => m.user_id) : [];
                        users = allUsers ? allUsers.filter(u => !memberIds.includes(u.id)) : [];
                    }
                    
                    if (users.length === 0) {
                        resultsContainer.innerHTML = `
                            <div style="text-align: center; color: #6b7280; padding: 20px;">
                                <i class="fas fa-user-slash" style="font-size: 32px; margin-bottom: 12px;"></i>
                                <p>No users found or all users are already in the channel</p>
                            </div>
                        `;
                        return;
                    }
                    
                    resultsContainer.innerHTML = users.map(user => `
                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8fafc; border-radius: 8px; margin-bottom: 8px; border: 1px solid #e5e7eb;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #1e40af, #06b6d4); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 16px;">
                                ${user.profile_photo ? 
                                    `<img src="${user.profile_photo}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` :
                                    (user.full_name || user.username).charAt(0).toUpperCase()
                                }
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 600; font-size: 14px; color: #1f2937;">${user.full_name || user.username}</div>
                                <div style="font-size: 12px; color: #6b7280;">@${user.username}</div>
                                ${user.job_title ? `<div style="font-size: 12px; color: #1e40af;">${user.job_title}</div>` : ''}
                            </div>
                            <button onclick="window.authManager.addUserToChannel('${channelId}', '${user.id}', this)" style="background: #f59e0b; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 12px; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-plus"></i> Add
                            </button>
                        </div>
                    `).join('');
                    
                } catch (error) {
                    console.error('Error searching users:', error);
                    resultsContainer.innerHTML = `
                        <div style="text-align: center; color: #ef4444; padding: 20px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 12px;"></i>
                            <p>Error searching users. Please try again.</p>
                        </div>
                    `;
                }
            }
            
            async addUserToChannel(channelId, userId, buttonElement) {
                try {
                    if (isSupabaseEnabled) {
                        const { error } = await supabase
                            .from('channel_members')
                            .insert({
                                channel_id: channelId,
                                user_id: userId,
                                role: 'member'
                            });
                        
                        if (error) throw error;
                    }
                    
                    // Update button to show success
                    buttonElement.innerHTML = '<i class="fas fa-check"></i> Added';
                    buttonElement.style.background = '#6b7280';
                    buttonElement.disabled = true;
                    
                    this.showNotification('User added to channel successfully!', 'success');
                } catch (error) {
                    console.error('Error adding user to channel:', error);
                    this.showNotification('Failed to add user to channel', 'error');
                }
            }
            
            async showGroupSettings(groupId) {
                let group = null;
                if (isSupabaseEnabled) {
                    try {
                        const { data } = await supabase.from('groups').select('*').eq('id', groupId).single();
                        group = data;
                    } catch (error) {
                        console.error('Error loading group:', error);
                    }
                }
                
                if (!group) return;
                
                const modal = document.createElement('div');
                modal.className = 'overlay';
                modal.innerHTML = `
                    <div class="settings-modal" style="max-width: 400px;">
                        <div class="settings-header" style="background: #10b981; color: white;">
                            <h3><i class="fas fa-cog"></i> Group Settings</h3>
                            <button class="close-btn" onclick="this.closest('.overlay').remove()" style="color: white;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="settings-content">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <div style="width: 80px; height: 80px; border-radius: 50%; background: #10b981; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 32px; margin: 0 auto 12px; cursor: pointer;" onclick="document.getElementById('groupPhotoInput').click();">
                                    ${group.group_photo ? `<img src="${group.group_photo}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` : group.name.charAt(0).toUpperCase()}
                                </div>
                                <button class="btn" style="background: #10b981; color: white; font-size: 12px; padding: 6px 12px;" onclick="document.getElementById('groupPhotoInput').click()">
                                    <i class="fas fa-camera"></i> Change Photo
                                </button>
                            </div>
                            
                            <div class="setting-item" style="margin-bottom: 16px;">
                                <label>Group Name</label>
                                <input type="text" id="groupNameEdit" value="${group.name}" class="setting-input" style="width: 100%; max-width: none;">
                            </div>
                            
                            <div class="setting-item" style="margin-bottom: 16px;">
                                <label>Description</label>
                                <textarea id="groupDescEdit" class="setting-input" style="width: 100%; max-width: none; min-height: 60px;">${group.description || ''}</textarea>
                            </div>
                            
                            <div style="display: flex; gap: 8px; margin-top: 20px;">
                                <button class="btn" style="background: #10b981; color: white; flex: 1;" onclick="window.authManager.saveGroupSettings('${groupId}')">
                                    <i class="fas fa-save"></i> Save
                                </button>
                                <button class="btn" style="background: #ef4444; color: white; flex: 1;" onclick="window.authManager.deleteGroup('${groupId}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Add hidden file input for group photo
                if (!document.getElementById('groupPhotoInput')) {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.id = 'groupPhotoInput';
                    input.accept = 'image/*';
                    input.style.display = 'none';
                    input.onchange = (e) => this.uploadGroupPhoto(groupId, e.target.files[0]);
                    document.body.appendChild(input);
                }
            }
            
            async showChannelSettings(channelId) {
                let channel = null;
                if (isSupabaseEnabled) {
                    try {
                        const { data } = await supabase.from('channels').select('*').eq('id', channelId).single();
                        channel = data;
                    } catch (error) {
                        console.error('Error loading channel:', error);
                    }
                }
                
                if (!channel) return;
                
                const modal = document.createElement('div');
                modal.className = 'overlay';
                modal.innerHTML = `
                    <div class="settings-modal" style="max-width: 400px;">
                        <div class="settings-header" style="background: #f59e0b; color: white;">
                            <h3><i class="fas fa-cog"></i> Channel Settings</h3>
                            <button class="close-btn" onclick="this.closest('.overlay').remove()" style="color: white;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="settings-content">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <div style="width: 80px; height: 80px; border-radius: 50%; background: #f59e0b; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 32px; margin: 0 auto 12px; cursor: pointer;" onclick="document.getElementById('channelPhotoInput').click();">
                                    ${channel.channel_photo ? `<img src="${channel.channel_photo}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` : channel.name.charAt(0).toUpperCase()}
                                </div>
                                <button class="btn" style="background: #f59e0b; color: white; font-size: 12px; padding: 6px 12px;" onclick="document.getElementById('channelPhotoInput').click()">
                                    <i class="fas fa-camera"></i> Change Photo
                                </button>
                            </div>
                            
                            <div class="setting-item" style="margin-bottom: 16px;">
                                <label>Channel Name</label>
                                <input type="text" id="channelNameEdit" value="${channel.name}" class="setting-input" style="width: 100%; max-width: none;">
                            </div>
                            
                            <div class="setting-item" style="margin-bottom: 16px;">
                                <label>Description</label>
                                <textarea id="channelDescEdit" class="setting-input" style="width: 100%; max-width: none; min-height: 60px;">${channel.description || ''}</textarea>
                            </div>
                            
                            <div class="setting-item" style="margin-bottom: 16px;">
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="channelDisabled" ${channel.is_disabled ? 'checked' : ''}>
                                    <span>Disable Channel</span>
                                </label>
                                <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">Disabled channels are hidden from users</div>
                            </div>
                            
                            <div style="display: flex; gap: 8px; margin-top: 20px;">
                                <button class="btn" style="background: #f59e0b; color: white; flex: 1;" onclick="window.authManager.saveChannelSettings('${channelId}')">
                                    <i class="fas fa-save"></i> Save
                                </button>
                                <button class="btn" style="background: #ef4444; color: white; flex: 1;" onclick="window.authManager.deleteChannel('${channelId}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Add hidden file input for channel photo
                if (!document.getElementById('channelPhotoInput')) {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.id = 'channelPhotoInput';
                    input.accept = 'image/*';
                    input.style.display = 'none';
                    input.onchange = (e) => this.uploadChannelPhoto(channelId, e.target.files[0]);
                    document.body.appendChild(input);
                }
            }
            
            async openGroup(groupId) {
                try {
                    let group = null;
                    if (isSupabaseEnabled) {
                        const { data } = await supabase
                            .from('groups')
                            .select('*')
                            .eq('id', groupId)
                            .single();
                        group = data;
                    }
                    
                    if (!group) {
                        this.showNotification('Group not found', 'error');
                        return;
                    }
                    
                    // Close any open modals
                    document.querySelectorAll('.overlay').forEach(modal => modal.remove());
                    
                    // Switch to group chat view
                    window.chatManager.startGroupConversation(groupId, group);
                } catch (error) {
                    console.error('Error opening group:', error);
                    this.showNotification('Failed to open group', 'error');
                }
            }
            
            async openChannel(channelId) {
                try {
                    let channel = null;
                    if (isSupabaseEnabled) {
                        const { data } = await supabase
                            .from('channels')
                            .select('*')
                            .eq('id', channelId)
                            .single();
                        channel = data;
                    }
                    
                    if (!channel) {
                        this.showNotification('Channel not found', 'error');
                        return;
                    }
                    
                    // Close any open modals
                    document.querySelectorAll('.overlay').forEach(modal => modal.remove());
                    
                    // Switch to channel view
                    window.chatManager.startChannelConversation(channelId, channel);
                } catch (error) {
                    console.error('Error opening channel:', error);
                    this.showNotification('Failed to open channel', 'error');
                }
            }
            
            async showMyGroups() {
                let myGroups = [];
                if (isSupabaseEnabled) {
                    try {
                        const { data } = await supabase.from('groups').select('*').eq('creator_id', this.currentUser.id);
                        myGroups = data || [];
                        
                        // Get member counts for each group
                        for (let group of myGroups) {
                            const { data: members } = await supabase.from('group_members').select('user_id').eq('group_id', group.id);
                            group.memberCount = members ? members.length : 0;
                        }
                    } catch (error) {
                        console.error('Error loading groups:', error);
                    }
                }
                
                const modal = document.createElement('div');
                modal.className = 'overlay';
                modal.innerHTML = `
                    <div class="settings-modal" style="max-width: 400px;">
                        <div class="settings-header" style="background: #10b981; color: white;">
                            <h3><i class="fas fa-users"></i> My Groups</h3>
                            <button class="close-btn" onclick="this.closest('.overlay').remove()" style="color: white;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="settings-content">
                            ${myGroups.length > 0 ? myGroups.map(group => `
                                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8fafc; border-radius: 8px; margin-bottom: 8px; border: 1px solid #e5e7eb;">
                                    <div onclick="window.authManager.openGroup('${group.id}')" style="display: flex; align-items: center; gap: 12px; flex: 1; cursor: pointer;">
                                        <div style="width: 40px; height: 40px; border-radius: 50%; background: #10b981; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                                            ${group.group_photo ? `<img src="${group.group_photo}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` : group.name.charAt(0).toUpperCase()}
                                        </div>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; color: #1f2937;">${group.name}</div>
                                            <div style="font-size: 12px; color: #6b7280;">${group.memberCount || 0} members</div>
                                        </div>
                                    </div>
                                    <button onclick="window.authManager.showGroupSettings('${group.id}')" style="background: #6b7280; color: white; border: none; padding: 6px 8px; border-radius: 6px; font-size: 12px; margin-right: 4px;">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                    <button onclick="window.authManager.showAddUsersToGroup('${group.id}')" style="background: #10b981; color: white; border: none; padding: 6px 8px; border-radius: 6px; font-size: 12px;">
                                        <i class="fas fa-user-plus"></i>
                                    </button>
                                </div>
                            `).join('') : '<div style="text-align: center; color: #6b7280; padding: 40px;"><i class="fas fa-users" style="font-size: 32px; margin-bottom: 12px;"></i><p>No groups created yet</p></div>'}
                            <button class="btn" style="background: #10b981; color: white; width: 100%; margin-top: 16px;" onclick="window.authManager.showCreateGroup(); this.closest('.overlay').remove();">
                                <i class="fas fa-plus"></i> Create Group
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            async showMyChannels() {
                let myChannels = [];
                if (isSupabaseEnabled) {
                    try {
                        const { data } = await supabase.from('channels').select('*').eq('creator_id', this.currentUser.id);
                        myChannels = data || [];
                        
                        // Get member counts for each channel
                        for (let channel of myChannels) {
                            const { data: members } = await supabase.from('channel_members').select('user_id').eq('channel_id', channel.id);
                            channel.memberCount = members ? members.length : 0;
                        }
                    } catch (error) {
                        console.error('Error loading channels:', error);
                    }
                }
                
                const modal = document.createElement('div');
                modal.className = 'overlay';
                modal.innerHTML = `
                    <div class="settings-modal" style="max-width: 400px;">
                        <div class="settings-header" style="background: #f59e0b; color: white;">
                            <h3><i class="fas fa-broadcast-tower"></i> My Channels</h3>
                            <button class="close-btn" onclick="this.closest('.overlay').remove()" style="color: white;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="settings-content">
                            ${myChannels.length > 0 ? myChannels.map(channel => `
                                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8fafc; border-radius: 8px; margin-bottom: 8px; border: 1px solid #e5e7eb; ${channel.is_disabled ? 'opacity: 0.6;' : ''}">
                                    <div onclick="window.authManager.openChannel('${channel.id}')" style="display: flex; align-items: center; gap: 12px; flex: 1; cursor: pointer;">
                                        <div style="width: 40px; height: 40px; border-radius: 50%; background: #f59e0b; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                                            ${channel.channel_photo ? `<img src="${channel.channel_photo}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` : channel.name.charAt(0).toUpperCase()}
                                        </div>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; color: #1f2937;">${channel.name} ${channel.is_disabled ? '(Disabled)' : ''}</div>
                                            <div style="font-size: 12px; color: #6b7280;">${channel.memberCount || 0} members</div>
                                        </div>
                                    </div>
                                    <button onclick="window.authManager.showChannelSettings('${channel.id}')" style="background: #6b7280; color: white; border: none; padding: 6px 8px; border-radius: 6px; font-size: 12px; margin-right: 4px;">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                    <button onclick="window.authManager.showAddUsersToChannel('${channel.id}')" style="background: #f59e0b; color: white; border: none; padding: 6px 8px; border-radius: 6px; font-size: 12px;">
                                        <i class="fas fa-user-plus"></i>
                                    </button>
                                </div>
                            `).join('') : '<div style="text-align: center; color: #6b7280; padding: 40px;"><i class="fas fa-broadcast-tower" style="font-size: 32px; margin-bottom: 12px;"></i><p>No channels created yet</p></div>'}
                            <button class="btn" style="background: #f59e0b; color: white; width: 100%; margin-top: 16px;" onclick="window.authManager.showCreateChannel(); this.closest('.overlay').remove();">
                                <i class="fas fa-plus"></i> Create Channel
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            toggleGroupsChannelsDropdown() {
                const dropdown = document.getElementById('groupsChannelsDropdown');
                const isVisible = dropdown.style.display === 'block';
                
                // Hide all other dropdowns first
                document.querySelectorAll('[id$="Dropdown"]').forEach(d => d.style.display = 'none');
                
                if (isVisible) {
                    dropdown.style.display = 'none';
                } else {
                    dropdown.style.display = 'block';
                    
                    // Close dropdown when clicking outside
                    setTimeout(() => {
                        document.addEventListener('click', this.handleOutsideClick.bind(this), { once: true });
                    }, 100);
                }
            }
            
            hideGroupsChannelsDropdown() {
                const dropdown = document.getElementById('groupsChannelsDropdown');
                if (dropdown) {
                    dropdown.style.display = 'none';
                }
            }
            
            handleOutsideClick(event) {
                const dropdown = document.getElementById('groupsChannelsDropdown');
                const button = document.getElementById('groupsChannelsBtn');
                
                if (dropdown && button && !dropdown.contains(event.target) && !button.contains(event.target)) {
                    dropdown.style.display = 'none';
                }
            }

            async saveGroupSettings(groupId) {
                try {
                    const name = document.getElementById('groupNameEdit').value.trim();
                    const description = document.getElementById('groupDescEdit').value.trim();
                    
                    if (!name) {
                        this.showNotification('Group name is required', 'error');
                        return;
                    }
                    
                    if (isSupabaseEnabled) {
                        const { error } = await supabase
                            .from('groups')
                            .update({ name, description })
                            .eq('id', groupId);
                        
                        if (error) throw error;
                    }
                    
                    this.showNotification('Group settings saved!', 'success');
                    document.querySelector('.overlay').remove();
                    this.showMyGroups();
                } catch (error) {
                    console.error('Error saving group settings:', error);
                    this.showNotification('Failed to save settings', 'error');
                }
            }
            
            async saveChannelSettings(channelId) {
                try {
                    const name = document.getElementById('channelNameEdit').value.trim();
                    const description = document.getElementById('channelDescEdit').value.trim();
                    const isDisabled = document.getElementById('channelDisabled').checked;
                    
                    if (!name) {
                        this.showNotification('Channel name is required', 'error');
                        return;
                    }
                    
                    if (isSupabaseEnabled) {
                        const { error } = await supabase
                            .from('channels')
                            .update({ name, description, is_disabled: isDisabled })
                            .eq('id', channelId);
                        
                        if (error) throw error;
                    }
                    
                    this.showNotification('Channel settings saved!', 'success');
                    document.querySelector('.overlay').remove();
                    this.showMyChannels();
                } catch (error) {
                    console.error('Error saving channel settings:', error);
                    this.showNotification('Failed to save settings', 'error');
                }
            }
            
            async uploadGroupPhoto(groupId, file) {
                if (!file) return;
                
                try {
                    // Validate file type and size
                    if (!file.type.startsWith('image/')) {
                        throw new Error('Please select an image file');
                    }
                    if (file.size > 5 * 1024 * 1024) {
                        throw new Error('Image size must be less than 5MB');
                    }
                    
                    this.showNotification('Uploading group photo...', 'success');
                    
                    let photoUrl;
                    if (isSupabaseEnabled) {
                        // Delete old photo if exists
                        const { data: oldGroup } = await supabase.from('groups').select('group_photo').eq('id', groupId).single();
                        if (oldGroup?.group_photo && oldGroup.group_photo.includes('supabase')) {
                            const oldFileName = oldGroup.group_photo.split('/').pop();
                            await supabase.storage.from('documents').remove([oldFileName]);
                        }
                        
                        const fileName = `group_${groupId}_${Date.now()}.${file.name.split('.').pop()}`;
                        const { data, error: uploadError } = await supabase.storage.from('documents').upload(fileName, file, {
                            cacheControl: '3600',
                            upsert: false
                        });
                        
                        if (uploadError) {
                            console.error('Storage upload error:', uploadError);
                            throw new Error('Failed to upload to storage: ' + uploadError.message);
                        }
                        
                        const { data: urlData } = supabase.storage.from('documents').getPublicUrl(fileName);
                        photoUrl = urlData.publicUrl;
                        
                        const { error: updateError } = await supabase
                            .from('groups')
                            .update({ group_photo: photoUrl })
                            .eq('id', groupId);
                        
                        if (updateError) {
                            console.error('Database update error:', updateError);
                            throw new Error('Failed to update group: ' + updateError.message);
                        }
                    }
                    
                    this.showNotification('Group photo updated successfully!', 'success');
                    document.querySelector('.overlay').remove();
                    this.showGroupSettings(groupId);
                } catch (error) {
                    console.error('Error uploading group photo:', error);
                    this.showNotification(error.message || 'Failed to upload photo', 'error');
                }
            }
            
            async uploadChannelPhoto(channelId, file) {
                if (!file) return;
                
                try {
                    // Validate file type and size
                    if (!file.type.startsWith('image/')) {
                        throw new Error('Please select an image file');
                    }
                    if (file.size > 5 * 1024 * 1024) {
                        throw new Error('Image size must be less than 5MB');
                    }
                    
                    this.showNotification('Uploading channel photo...', 'success');
                    
                    let photoUrl;
                    if (isSupabaseEnabled) {
                        // Delete old photo if exists
                        const { data: oldChannel } = await supabase.from('channels').select('channel_photo').eq('id', channelId).single();
                        if (oldChannel?.channel_photo && oldChannel.channel_photo.includes('supabase')) {
                            const oldFileName = oldChannel.channel_photo.split('/').pop();
                            await supabase.storage.from('documents').remove([oldFileName]);
                        }
                        
                        const fileName = `channel_${channelId}_${Date.now()}.${file.name.split('.').pop()}`;
                        const { data, error: uploadError } = await supabase.storage.from('documents').upload(fileName, file, {
                            cacheControl: '3600',
                            upsert: false
                        });
                        
                        if (uploadError) {
                            console.error('Storage upload error:', uploadError);
                            throw new Error('Failed to upload to storage: ' + uploadError.message);
                        }
                        
                        const { data: urlData } = supabase.storage.from('documents').getPublicUrl(fileName);
                        photoUrl = urlData.publicUrl;
                        
                        const { error: updateError } = await supabase
                            .from('channels')
                            .update({ channel_photo: photoUrl })
                            .eq('id', channelId);
                        
                        if (updateError) {
                            console.error('Database update error:', updateError);
                            throw new Error('Failed to update channel: ' + updateError.message);
                        }
                    }
                    
                    this.showNotification('Channel photo updated successfully!', 'success');
                    document.querySelector('.overlay').remove();
                    this.showChannelSettings(channelId);
                } catch (error) {
                    console.error('Error uploading channel photo:', error);
                    this.showNotification(error.message || 'Failed to upload photo', 'error');
                }
            }
            
            getCurrentUser() { return this.currentUser; }
            getAllUsers() { return this.users; }
            getUserById(id) { return this.users.find(u => u.id === id); }
            getUserByEmail(email) { return this.users.find(u => u.email === email); }
            getUserByUsername(username) { return this.users.find(u => u.username === username); }
        }


        // Search Manager
        class SearchManager {
            constructor() {
                // Search is now handled via modals
            }

            initialize() {
                // Setup search functionality
            }

            setupEventListeners() {
                // Event listeners are now set up dynamically in modals
            }

            async searchUsers(query, containerId = 'searchResults') {
                let users = [];
                
                if (isSupabaseEnabled) {
                    try {
                        // Search in Supabase profiles table
                        const { data, error } = await supabase
                            .from('profiles')
                            .select('*')
                            .or(`username.ilike.%${query}%,email.ilike.%${query}%,full_name.ilike.%${query}%`)
                            .limit(10);
                        
                        if (error) throw error;
                        users = data || [];
                    } catch (error) {
                        console.error('Error searching users:', error);
                    }
                }
                
                // Fallback to local search
                if (users.length === 0) {
                    users = window.authManager.getAllUsers().filter(user => 
                        user.username.toLowerCase().includes(query.toLowerCase()) ||
                        user.email.toLowerCase().includes(query.toLowerCase()) ||
                        (user.full_name && user.full_name.toLowerCase().includes(query.toLowerCase()))
                    );
                }

                this.displayResults(users, containerId);
            }

            async searchByUid(uid) {
                if (isSupabaseEnabled) {
                    try {
                        const { data, error } = await supabase
                            .from('profiles')
                            .select('*')
                            .eq('id', uid)
                            .single();

                        if (error) throw error;
                        this.displayResults(data ? [data] : []);
                    } catch (error) {
                        console.error('Error searching by UID:', error);
                        this.displayResults([]);
                    }
                } else {
                    const user = window.authManager.getUserById(uid);
                    this.displayResults(user ? [user] : []);
                }
            }

            async startChatWithUid(uid) {
                if (window.chatManager) {
                    await window.chatManager.startConversation(uid);
                    this.uidSearchInput.value = '';
                    this.hideResults();
                }
            }

            displayResults(users, containerId = 'searchResults') {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                if (!users || users.length === 0) {
                    container.innerHTML = '<div class="search-result-item">No users found</div>';
                    return;
                }

                container.innerHTML = users.map(user => `
                    <div class="search-result-item" onclick="window.searchManager.selectUser('${user.id}')">
                        <div class="search-result-avatar">${(user.full_name || user.username).charAt(0).toUpperCase()}</div>
                        <div class="search-result-info">
                            <div class="search-result-name">${user.full_name || user.username}</div>
                            <div class="search-result-username">@${user.username}</div>
                            <div class="search-result-email">${user.email}</div>
                        </div>
                    </div>
                `).join('');
            }

            selectUser(userId) {
                if (window.chatManager) {
                    window.chatManager.startConversation(userId);
                    this.userSearchInput.value = '';
                    this.hideResults();
                }
            }

            hideResults() {
                // Results are now in modals
            }
        }

        // Initialize the application
        try {
            window.authManager = new AuthManager();
            // ChatManager is initialized in external file
            window.searchManager = new SearchManager();
            
            console.log('BusinessConnect initialized successfully');
        } catch (error) {
            console.error('Failed to initialize BusinessConnect:', error);
            document.body.innerHTML = `
                <div style="display: flex; justify-content: center; align-items: center; height: 100vh; background: #f8fafc;">
                    <div style="text-align: center; padding: 40px; background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #f59e0b; margin-bottom: 16px;"></i>
                        <h2>Initialization Error</h2>
                        <p>Failed to start BusinessConnect. Please refresh the page.</p>
                        <button onclick="window.location.reload()" style="margin-top: 16px; padding: 12px 24px; background: #1e40af; color: white; border: none; border-radius: 8px; cursor: pointer;">Refresh Page</button>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>